{% extends "base.html" %}

{% block title %}æˆç¸¾æŸ¥çœ‹ - {{ quiz_bank.title }}{% endblock %}

{% block content %}
<div>
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <div>
            <h1 style="color: #333; margin-bottom: 0.5rem;">ğŸ“Š æˆç¸¾çµ±è¨ˆ</h1>
            <p style="color: #666;">{{ quiz_bank.title }} - é¡Œåº«ä»£ç¢¼ï¼š{{ quiz_bank.access_code }}</p>
        </div>
        <div style="display: flex; gap: 1rem;">
            <button onclick="exportToCSV()" class="btn btn-secondary">ğŸ“„ åŒ¯å‡ºCSV</button>
            <a href="{{ url_for('manage_quiz_bank', quiz_bank_id=quiz_bank.id) }}" class="btn">â† è¿”å›é¡Œåº«</a>
        </div>
    </div>
    
    <div id="submissions-container">
        <div style="text-align: center; padding: 2rem;">
            <div class="loading" style="margin: 0 auto;"></div>
            <p style="margin-top: 1rem; color: #666;">è¼‰å…¥æˆç¸¾è³‡æ–™ä¸­...</p>
        </div>
    </div>
    
    <!-- çµ±è¨ˆæ‘˜è¦ -->
    <div id="statistics-summary" style="display: none; margin-bottom: 2rem;">
        <div class="card">
            <div class="card-header">
                <h3 style="margin: 0;">ğŸ“ˆ çµ±è¨ˆæ‘˜è¦</h3>
            </div>
            <div class="card-body">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
                    <div style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                        <div style="font-size: 2rem; font-weight: bold; color: #667eea;" id="total-submissions">0</div>
                        <div style="color: #666;">ç¸½ä½œç­”äººæ•¸</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                        <div style="font-size: 2rem; font-weight: bold; color: #27ae60;" id="average-score">0%</div>
                        <div style="color: #666;">å¹³å‡åˆ†æ•¸</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                        <div style="font-size: 2rem; font-weight: bold; color: #e74c3c;" id="highest-score">0%</div>
                        <div style="color: #666;">æœ€é«˜åˆ†æ•¸</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                        <div style="font-size: 2rem; font-weight: bold; color: #f39c12;" id="pass-rate">0%</div>
                        <div style="color: #666;">åŠæ ¼ç‡ (60åˆ†ä»¥ä¸Š)</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æˆç¸¾åˆ—è¡¨ -->
    <div id="submissions-table" style="display: none;">
        <div class="card">
            <div class="card-header">
                <h3 style="margin: 0;">ğŸ“‹ è©³ç´°æˆç¸¾</h3>
            </div>
            <div class="card-body" style="padding: 0; overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            <th style="padding: 1rem; border-bottom: 1px solid #e9ecef; text-align: left;">æ’å</th>
                            <th style="padding: 1rem; border-bottom: 1px solid #e9ecef; text-align: left;">å­¸ç”Ÿå§“å</th>
                            <th style="padding: 1rem; border-bottom: 1px solid #e9ecef; text-align: left;">é›»å­éƒµä»¶</th>
                            <th style="padding: 1rem; border-bottom: 1px solid #e9ecef; text-align: center;">å¾—åˆ†</th>
                            <th style="padding: 1rem; border-bottom: 1px solid #e9ecef; text-align: center;">ç™¾åˆ†æ¯”</th>
                            <th style="padding: 1rem; border-bottom: 1px solid #e9ecef; text-align: left;">å®Œæˆæ™‚é–“</th>
                            <th style="padding: 1rem; border-bottom: 1px solid #e9ecef; text-align: center;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="submissions-tbody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div id="no-submissions" style="display: none; text-align: center; padding: 3rem; background: #f8f9fa; border-radius: 10px;">
        <h3 style="color: #666; margin-bottom: 1rem;">ğŸ“ é‚„æ²’æœ‰å­¸ç”Ÿä½œç­”</h3>
        <p style="color: #888; margin-bottom: 2rem;">ç­‰å¾…å­¸ç”Ÿä½¿ç”¨é¡Œåº«ä»£ç¢¼é€²è¡Œæ¸¬é©—</p>
        <div style="background: white; padding: 1rem; border-radius: 8px; display: inline-block;">
            <strong>é¡Œåº«ä»£ç¢¼ï¼š</strong>
            <span class="access-code" style="font-size: 1.2rem;">{{ quiz_bank.access_code }}</span>
            <button onclick="copyQuizLink('{{ quiz_bank.access_code }}')" class="btn btn-secondary" style="margin-left: 1rem; padding: 6px 12px;">ğŸ“‹ è¤‡è£½é€£çµ</button>
        </div>
    </div>
</div>

<script>
let submissionsData = [];

// è¼‰å…¥æˆç¸¾è³‡æ–™
async function loadSubmissions() {
    try {
        const response = await fetch('/api/quiz-bank/{{ quiz_bank.id }}/submissions');
        if (response.ok) {
            submissionsData = await response.json();
            displaySubmissions();
        } else {
            throw new Error('è¼‰å…¥å¤±æ•—');
        }
    } catch (error) {
        document.getElementById('submissions-container').innerHTML = `
            <div style="text-align: center; padding: 2rem; color: #e74c3c;">
                <h3>è¼‰å…¥å¤±æ•—</h3>
                <p>ç„¡æ³•è¼‰å…¥æˆç¸¾è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦</p>
                <button onclick="loadSubmissions()" class="btn">é‡æ–°è¼‰å…¥</button>
            </div>
        `;
    }
}

function displaySubmissions() {
    document.getElementById('submissions-container').style.display = 'none';
    
    if (submissionsData.length === 0) {
        document.getElementById('no-submissions').style.display = 'block';
        return;
    }
    
    // é¡¯ç¤ºçµ±è¨ˆæ‘˜è¦
    displayStatistics();
    
    // é¡¯ç¤ºæˆç¸¾è¡¨æ ¼
    displaySubmissionsTable();
}

function displayStatistics() {
    const totalSubmissions = submissionsData.length;
    const averageScore = totalSubmissions > 0 ? 
        submissionsData.reduce((sum, s) => sum + s.percentage, 0) / totalSubmissions : 0;
    const highestScore = totalSubmissions > 0 ? 
        Math.max(...submissionsData.map(s => s.percentage)) : 0;
    const passCount = submissionsData.filter(s => s.percentage >= 60).length;
    const passRate = totalSubmissions > 0 ? (passCount / totalSubmissions) * 100 : 0;
    
    document.getElementById('total-submissions').textContent = totalSubmissions;
    document.getElementById('average-score').textContent = averageScore.toFixed(1) + '%';
    document.getElementById('highest-score').textContent = highestScore.toFixed(1) + '%';
    document.getElementById('pass-rate').textContent = passRate.toFixed(1) + '%';
    
    document.getElementById('statistics-summary').style.display = 'block';
}

function displaySubmissionsTable() {
    // æŒ‰åˆ†æ•¸æ’åº
    const sortedSubmissions = [...submissionsData].sort((a, b) => b.percentage - a.percentage);
    
    const tbody = document.getElementById('submissions-tbody');
    tbody.innerHTML = '';
    
    sortedSubmissions.forEach((submission, index) => {
        const row = document.createElement('tr');
        row.style.borderBottom = '1px solid #e9ecef';
        
        // è¨­å®šæ’åé¡è‰²
        let rankColor = '#666';
        if (index === 0) rankColor = '#f39c12'; // é‡‘è‰²
        else if (index === 1) rankColor = '#95a5a6'; // éŠ€è‰²
        else if (index === 2) rankColor = '#e67e22'; // éŠ…è‰²
        
        // è¨­å®šåˆ†æ•¸é¡è‰²
        let scoreColor = '#e74c3c';
        if (submission.percentage >= 80) scoreColor = '#27ae60';
        else if (submission.percentage >= 60) scoreColor = '#f39c12';
        
        row.innerHTML = `
            <td style="padding: 1rem; color: ${rankColor}; font-weight: bold;">
                ${index + 1}
                ${index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : ''}
            </td>
            <td style="padding: 1rem; font-weight: bold;">
                ${submission.student_name}
            </td>
            <td style="padding: 1rem; color: #666;">
                ${submission.student_email || '-'}
            </td>
            <td style="padding: 1rem; text-align: center;">
                ${submission.score} / ${submission.total_points}
            </td>
            <td style="padding: 1rem; text-align: center; font-weight: bold; color: ${scoreColor};">
                ${submission.percentage.toFixed(1)}%
            </td>
            <td style="padding: 1rem; color: #666;">
                ${submission.submitted_at}
            </td>
            <td style="padding: 1rem; text-align: center;">
                <a href="/result/${submission.id}" target="_blank" class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.9rem;">
                    æŸ¥çœ‹è©³æƒ…
                </a>
            </td>
        `;
        
        tbody.appendChild(row);
    });
    
    document.getElementById('submissions-table').style.display = 'block';
}

function exportToCSV() {
    if (submissionsData.length === 0) {
        alert('æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡º');
        return;
    }
    
    // æº–å‚™CSVè³‡æ–™
    const headers = ['æ’å', 'å­¸ç”Ÿå§“å', 'é›»å­éƒµä»¶', 'å¾—åˆ†', 'ç¸½åˆ†', 'ç™¾åˆ†æ¯”', 'å®Œæˆæ™‚é–“'];
    const sortedSubmissions = [...submissionsData].sort((a, b) => b.percentage - a.percentage);
    
    let csvContent = headers.join(',') + '\n';
    
    sortedSubmissions.forEach((submission, index) => {
        const row = [
            index + 1,
            `"${submission.student_name}"`,
            `"${submission.student_email || ''}"`,
            submission.score,
            submission.total_points,
            submission.percentage.toFixed(1),
            `"${submission.submitted_at}"`
        ];
        csvContent += row.join(',') + '\n';
    });
    
    // ä¸‹è¼‰CSVæª”æ¡ˆ
    const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `{{ quiz_bank.title }}_æˆç¸¾çµ±è¨ˆ.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function copyQuizLink(accessCode) {
    const link = window.location.origin + '/quiz/' + accessCode;
    
    if (navigator.clipboard) {
        navigator.clipboard.writeText(link).then(() => {
            alert('é¡Œåº«é€£çµå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼\n' + link);
        }).catch(() => {
            fallbackCopyTextToClipboard(link);
        });
    } else {
        fallbackCopyTextToClipboard(link);
    }
}

function fallbackCopyTextToClipboard(text) {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    textArea.style.position = "fixed";
    textArea.style.left = "-999999px";
    textArea.style.top = "-999999px";
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        document.execCommand('copy');
        alert('é¡Œåº«é€£çµå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼\n' + text);
    } catch (err) {
        alert('ç„¡æ³•è¤‡è£½é€£çµï¼Œè«‹æ‰‹å‹•è¤‡è£½ï¼š\n' + text);
    }
    
    document.body.removeChild(textArea);
}

// é é¢è¼‰å…¥æ™‚è¼‰å…¥è³‡æ–™
document.addEventListener('DOMContentLoaded', loadSubmissions);
</script>
{% endblock %}
