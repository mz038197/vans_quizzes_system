{% extends "base.html" %}

{% block title %}ç®¡ç†é¡Œåº« - {{ quiz_bank.title }}{% endblock %}

{% block content %}
<div>
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <div>
            <h1 style="color: #333; margin-bottom: 0.5rem;">ğŸ“ {{ quiz_bank.title }}</h1>
            <p style="color: #666;">é¡Œåº«ä»£ç¢¼ï¼š<span class="access-code">{{ quiz_bank.access_code }}</span></p>
        </div>
        <div style="display: flex; gap: 1rem;">
            <button onclick="showAddQuestionModal()" class="btn">â• æ–°å¢é¡Œç›®</button>
            <a href="{{ url_for('view_submissions_page', quiz_bank_id=quiz_bank.id) }}" class="btn btn-secondary">ğŸ“Š æŸ¥çœ‹æˆç¸¾</a>
            <a href="{{ url_for('teacher_dashboard') }}" class="btn btn-secondary">â† è¿”å›</a>
        </div>
    </div>
    
    <div id="questions-container">
        {% if questions %}
            {% for question in questions %}
            <div class="question-item" data-question-id="{{ question.id }}">
                <div class="question-header">
                    <div>
                        <strong>{{ question.title }}</strong>
                        <span class="question-type-badge">{{ get_question_type_name(question.question_type) }}</span>
                        <span style="color: #666; margin-left: 1rem;">{{ question.points }} åˆ†</span>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button onclick="editQuestion({{ question.id }})" class="btn" style="padding: 6px 12px;">âœï¸ ç·¨è¼¯</button>
                        <button onclick="deleteQuestion({{ question.id }})" class="btn btn-danger" style="padding: 6px 12px;">ğŸ—‘ï¸ åˆªé™¤</button>
                    </div>
                </div>
                <div class="question-content">
                    <p style="white-space: pre-wrap; font-family: Consolas, monospace;">{{ question.question_text | trim }}</p>
                    {% if question.question_data %}
                        {% set data = question.question_data | from_json %}
                        {% if question.question_type in ['single_choice', 'multiple_choice'] %}
                            <div style="margin-top: 1rem;">
                                {% for option in data.options %}
                                <div class="option" style="background: #f8f9fa;">
                                    <div class="option-text">{{ option }}</div>
                                    {% if (question.question_type == 'single_choice' and option == data.correct_answer) or 
                                           (question.question_type == 'multiple_choice' and option in data.correct_answers) %}
                                    <div class="option-correct">âœ“ æ­£ç¢ºç­”æ¡ˆ</div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        {% elif question.question_type == 'fill_blank' %}
                            <div style="margin-top: 1rem; color: #27ae60;">
                                <strong>æ­£ç¢ºç­”æ¡ˆï¼š</strong> {{ data.correct_answer }}
                            </div>
                        {% elif question.question_type == 'dropdown' %}
                            <div style="margin-top: 1rem;">
                                <strong>é¸é …ï¼š</strong> {{ data.options | join(', ') }}<br>
                                <strong style="color: #27ae60;">æ­£ç¢ºç­”æ¡ˆï¼š</strong> {{ data.correct_answer }}
                            </div>
                        {% elif question.question_type == 'dropdown_fillblank' %}
                            <div style="margin-top: 1rem;">
                                <div style="background: #f8f9fa; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                                    <strong>é¡Œç›®æ–‡å­—ï¼š</strong>
                                    <div style="margin-top: 0.5rem; font-family: Consolas, monospace;">{{ data.fillblank_text }}</div>
                                </div>
                                <strong>ç©ºæ ¼è¨­å®šï¼š</strong>
                                {% for blank in data.blanks %}
                                <div style="border: 1px solid #ddd; border-radius: 4px; padding: 0.8rem; margin: 0.5rem 0; background: white;">
                                    <div style="font-weight: bold; color: #666; margin-bottom: 0.5rem;">ç©ºæ ¼ {{ loop.index }}:</div>
                                    <div style="margin-bottom: 0.5rem;">
                                        <strong>é¸é …ï¼š</strong> {{ blank.options | join(', ') }}
                                    </div>
                                    <div style="color: #27ae60;">
                                        <strong>æ­£ç¢ºç­”æ¡ˆï¼š</strong> {{ blank.correct_answer }}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% elif question.question_type == 'parsons' %}
                            <div style="margin-top: 1rem;">
                                <div class="parsons-preview-container" style="display: flex; gap: 2rem; margin-top: 1rem;">
                                    <div class="parsons-preview-bank" style="flex: 1; border: 2px dashed #ddd; border-radius: 8px; padding: 1rem; background: #fafafa;">
                                        <h4 style="text-align: center; margin-bottom: 1rem; color: #666; font-size: 1rem;">å¯é¸ç¨‹å¼ç¢¼å¡Š</h4>
                                        {% for label in data.code_blocks.keys() | sort %}
                                        <div class="code-block-preview" style="background: #2d3748; color: #e2e8f0; padding: 0.4rem 1rem; margin: 0.3rem 0; border-radius: 6px; font-family: Consolas, monospace;  line-height: 1.4; font-size: 14px; overflow-x: auto; box-shadow: 0 2px 4px rgba(0,0,0,0.1); height: auto; min-height: 0; white-space: pre-wrap;">{{ data.code_blocks[label] | safe }}</div>
                                        {% endfor %}
                                    </div>
                                    <div class="parsons-preview-target" style="flex: 1; border: 2px dashed #667eea; border-radius: 8px; padding: 1rem; background: #f8f9ff;">
                                        <h4 style="text-align: center; margin-bottom: 1rem; color: #667eea; font-size: 1rem;">ç­”é¡Œå€ (å…± {{ data.answer_slots }} å€‹ç©ºæ ¼)</h4>
                                        {% set slot_indents = data.slot_indents or {} %}
                                        {% for i in range(1, data.answer_slots + 1) %}
                                        {% set slot_num = i|string %}
                                        {% set correct_label = data.slot_answers.get(slot_num, '') %}
                                        {% set is_fixed = data.fixed_blocks and (slot_num in data.fixed_blocks) %}
                                        {% set indent_level = slot_indents.get(slot_num, 0) if slot_indents else 0 %}
                                        {% if is_fixed %}
                                            {% set fixed = data.fixed_blocks[slot_num] %}
                                            {% set fixed_indent = fixed.indent if fixed.indent is defined else 0 %}
                                            {% set indent_level = fixed_indent %}
                                        {% endif %}
                                        {% set indent_px = indent_level * 20 %}
                                        <div class="answer-slot-preview" style="border: 2px dashed #bbb; border-radius: 8px; margin: 0.5rem 0; min-height: 60px; display: flex; align-items: center; padding: 0.5rem; background: white; position: relative; margin-left: {{ indent_px }}px;">
                                            {% if is_fixed %}
                                            <!-- å›ºå®šå€å¡Š -->
                                            <div style="flex: 1; background: #2d3748; color: #e2e8f0; padding: 0.4rem 1rem; border-radius: 6px; font-family: Consolas, monospace; line-height: 1.4; white-space: pre-wrap; font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">{{ fixed.content | safe }}</div>
                                            {% elif correct_label %}
                                            <div class="answer-block" style="flex: 1; background: #e8f5e8; color: #2d3748; padding: 0.4rem 1rem; border-radius: 6px; font-family: Consolas, monospace; line-height: 1.4; border: 2px solid #27ae60; font-size: 14px; overflow-x: auto; height: auto; min-height: 0;">
                                                <div style="display: flex; align-items: flex-start;">
                                                    <span style="color: #27ae60; font-weight: bold; margin-right: 0.5rem; display: inline-block; width: 30px; text-align: center; flex-shrink: 0;">âœ“ {{ correct_label }}</span>
                                                    <div style="text-align: left; flex-grow: 1; white-space: pre;">{{ data.code_blocks.get(correct_label, '') | safe }}</div>
                                                </div>
                                            </div>
                                            {% else %}
                                            <div style="flex: 1; color: #999; font-style: italic;">å°‡ç¨‹å¼ç¢¼å¡Šæ‹–æ‹‰åˆ°é€™è£¡</div>
                                            {% endif %}
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div style="text-align: center; padding: 3rem; background: #f8f9fa; border-radius: 10px;">
                <h3 style="color: #666; margin-bottom: 1rem;">ğŸ“ é‚„æ²’æœ‰é¡Œç›®</h3>
                <p style="color: #888; margin-bottom: 2rem;">é–‹å§‹å»ºç«‹æ‚¨çš„ç¬¬ä¸€å€‹é¡Œç›®å§ï¼</p>
                <button onclick="showAddQuestionModal()" class="btn">â• æ–°å¢é¡Œç›®</button>
            </div>
        {% endif %}
    </div>
</div>

<!-- æ–°å¢/ç·¨è¼¯é¡Œç›®çš„æ¨¡æ…‹æ¡† -->
<div id="question-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 10px; width: 90%; max-width: 800px; max-height: 90%; overflow-y: auto;">
        <div style="padding: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h2 id="modal-title">æ–°å¢é¡Œç›®</h2>
                <button onclick="hideQuestionModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">âœ•</button>
            </div>
            
            <form id="question-form">
                <div class="form-group">
                    <label for="question-title">é¡Œç›®æ¨™é¡Œ *</label>
                    <input type="text" id="question-title" required>
                </div>
                
                <div class="form-group">
                    <label for="question-text">é¡Œç›®å…§å®¹ * <span style="color: #667eea; font-size: 0.9rem;">(æ”¯æ´ LaTeX æ•¸å­¸å…¬å¼)</span></label>
                    <textarea id="question-text" rows="4" required placeholder="ä¾‹å¦‚ï¼šè¨ˆç®— $\int_0^1 x^2 dx$ çš„å€¼æ˜¯å¤šå°‘ï¼Ÿ" style="font-family: Consolas, monospace;"></textarea>
                    <p style="color: #666; font-size: 0.85rem; margin-top: 0.5rem;">
                        ğŸ’¡ LaTeX æç¤ºï¼šä½¿ç”¨ $...$ è¡¨ç¤ºè¡Œå…§å…¬å¼ï¼Œä½¿ç”¨ $$...$$ è¡¨ç¤ºç¨ç«‹å…¬å¼ã€‚ä¾‹å¦‚ï¼š$x^2 + y^2 = r^2$
                    </p>
                </div>
                
                <div class="form-group">
                    <label for="question-type">é¡Œç›®é¡å‹ *</label>
                    <select id="question-type" onchange="handleQuestionTypeChange()" required>
                        <option value="">è«‹é¸æ“‡é¡Œç›®é¡å‹</option>
                        <option value="single_choice">å–®é¸é¡Œ</option>
                        <option value="multiple_choice">å¤šé¸é¡Œ</option>
                        <option value="fill_blank">å¡«ç©ºé¡Œ</option>
                        <option value="dropdown">ä¸‹æ‹‰é¸å–®</option>
                        <option value="dropdown_fillblank">ä¸‹æ‹‰é¸å–®å¡«ç©ºé¡Œ</option>
                        <option value="parsons">ç¨‹å¼ç¢¼æ’åºé¡Œ</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="question-points">åˆ†æ•¸</label>
                    <input type="number" id="question-points" value="1" min="1">
                </div>
                
                <!-- å‹•æ…‹å…§å®¹å€åŸŸ -->
                <div id="question-specific-content"></div>
                
                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button type="submit" class="btn" style="flex: 1;">å„²å­˜é¡Œç›®</button>
                    <button type="button" onclick="hideQuestionModal()" class="btn btn-secondary" style="flex: 1;">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let currentQuestionId = null;

function showAddQuestionModal() {
    currentQuestionId = null;
    document.getElementById('modal-title').textContent = 'æ–°å¢é¡Œç›®';
    document.getElementById('question-form').reset();
    document.getElementById('question-specific-content').innerHTML = '';
    document.getElementById('question-modal').style.display = 'block';
}

function hideQuestionModal() {
    document.getElementById('question-modal').style.display = 'none';
}

function handleQuestionTypeChange() {
    const type = document.getElementById('question-type').value;
    const container = document.getElementById('question-specific-content');
    
    switch (type) {
        case 'single_choice':
        case 'multiple_choice':
            container.innerHTML = `
                <div class="form-group">
                    <label>é¸é … * <span style="color: #667eea; font-size: 0.9rem;">(æ”¯æ´ LaTeX æ•¸å­¸å…¬å¼)</span></label>
                    <div id="options-container">
                        <div class="option-row" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <textarea class="option-input" placeholder="é¸é …å…§å®¹ (æ”¯æ´å¤šè¡Œå’ŒLaTeXå…¬å¼ï¼Œä¾‹å¦‚ï¼š$\\\\frac{1}{2}$)" style="flex: 1; min-height: 60px;"></textarea>
                            <label style="margin: 0; display: flex; align-items: center;">
                                <input type="${type === 'single_choice' ? 'radio' : 'checkbox'}" name="correct-option" style="margin-right: 0.5rem;">
                                æ­£ç¢º
                            </label>
                            <button type="button" onclick="removeOption(this)" class="btn btn-danger" style="padding: 4px 8px;">åˆªé™¤</button>
                        </div>
                    </div>
                    <button type="button" onclick="addOption()" class="btn btn-secondary" style="margin-top: 0.5rem;">æ–°å¢é¸é …</button>
                </div>
            `;
            break;
            
        case 'fill_blank':
            container.innerHTML = `
                <div class="form-group">
                    <label for="correct-answer">æ­£ç¢ºç­”æ¡ˆ *</label>
                    <input type="text" id="correct-answer" required placeholder="è¼¸å…¥æ­£ç¢ºç­”æ¡ˆ">
                </div>
            `;
            break;
            
        case 'dropdown':
            container.innerHTML = `
                <div class="form-group">
                    <label>ä¸‹æ‹‰é¸é … *</label>
                    <div id="dropdown-options-container">
                        <div class="dropdown-option-row" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <textarea class="dropdown-option-input" placeholder="é¸é …å…§å®¹ (æ”¯æ´å¤šè¡Œ)" style="flex: 1; min-height: 60px;"></textarea>
                            <label style="margin: 0; display: flex; align-items: center;">
                                <input type="radio" name="correct-dropdown" style="margin-right: 0.5rem;">
                                æ­£ç¢º
                            </label>
                            <button type="button" onclick="removeDropdownOption(this)" class="btn btn-danger" style="padding: 4px 8px;">åˆªé™¤</button>
                        </div>
                    </div>
                    <button type="button" onclick="addDropdownOption()" class="btn btn-secondary" style="margin-top: 0.5rem;">æ–°å¢é¸é …</button>
                </div>
            `;
            break;
            
        case 'dropdown_fillblank':
            container.innerHTML = `
                <div class="form-group">
                    <label>å¡«ç©ºé¡Œç›®æ–‡å­— *</label>
                    <textarea id="fillblank-text" rows="3" placeholder="è«‹è¼¸å…¥é¡Œç›®æ–‡å­—ï¼Œä½¿ç”¨ {{ '{{}}' }} æ¨™è¨˜éœ€è¦å¡«ç©ºçš„ä½ç½®ã€‚ä¾‹å¦‚ï¼šç¨‹å¼è¨­è¨ˆä¸­ï¼Œ{{ '{{}}' }} æ˜¯ä¸€ç¨®æ§åˆ¶çµæ§‹ï¼Œç”¨ä¾†åŸ·è¡Œ {{ '{{}}' }} æ“ä½œã€‚" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                    <p style="color: #666; font-size: 0.9rem; margin-top: 0.5rem;">ä½¿ç”¨ {{ '{{}}' }} æ¨™è¨˜å¡«ç©ºä½ç½®ï¼Œç³»çµ±æœƒè‡ªå‹•ç‚ºæ¯å€‹ {{ '{{}}' }} ç”Ÿæˆå°æ‡‰çš„ä¸‹æ‹‰é¸å–®</p>
                </div>
                
                <div class="form-group">
                    <label>ç©ºæ ¼é¸é …è¨­å®š</label>
                    <div id="blanks-container" style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                        <p style="color: #666; margin-bottom: 1rem;">è«‹å…ˆåœ¨ä¸Šæ–¹æ–‡å­—ä¸­ä½¿ç”¨ {{ '{{}}' }} æ¨™è¨˜å¡«ç©ºä½ç½®ï¼Œç„¶å¾Œé»æ“Šä¸‹æ–¹æŒ‰éˆ•è§£æç©ºæ ¼</p>
                        <button type="button" onclick="parseBlanks()" class="btn btn-primary" style="margin-bottom: 1rem;">è§£æç©ºæ ¼</button>
                        <div id="blanks-options-container"></div>
                    </div>
                </div>
            `;
            break;
            
        case 'parsons':
            container.innerHTML = `
                <div class="form-group">
                    <label>å¯ä¾›é¸æ“‡çš„ç¨‹å¼ç¢¼å¡Š *</label>
                    <div id="code-blocks-container" style="background: #e8f5e8; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <div class="code-block-row" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem; align-items: center;">
                            <span style="min-width: 30px; color: #666;">A</span>
                            <textarea class="code-block-input" placeholder="ç¨‹å¼ç¢¼å¡Šå…§å®¹ (æ”¯æ´å¤šè¡Œ)" style="flex: 1; min-height: 60px; font-family: Consolas, monospace;" oninput="updateAnswerSlots(); updateParsonsPreview();"></textarea>
                            <button type="button" onclick="removeCodeBlock(this)" class="btn btn-danger" style="padding: 4px 8px;">åˆªé™¤</button>
                        </div>
                    </div>
                    <button type="button" onclick="addCodeBlock()" class="btn btn-success" style="margin-bottom: 1.5rem;">æ–°å¢ç¨‹å¼ç¢¼å¡Š</button>
                    
                    <label>ç­”æ¡ˆå€ç©ºæ ¼è¨­å®š *</label>
                    <div style="background: #f0f7ff; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <div style="display: flex; gap: 1rem; align-items: center; margin-bottom: 1rem;">
                            <label style="margin: 0;">ç­”æ¡ˆå€ç©ºæ ¼æ•¸é‡ï¼š</label>
                            <input type="number" id="answer-slots-count" min="1" value="3" style="width: 80px;" onchange="updateAnswerSlots(); updateParsonsPreview();">
                            <span style="color: #666; font-size: 0.9rem;">ï¼ˆè‡ªå‹•æ›´æ–°ï¼‰</span>
                            <span id="parsons-completion-status" style="margin-left: auto; padding: 0.3rem 0.8rem; border-radius: 4px; font-size: 0.9rem; font-weight: 500;"></span>
                        </div>
                        <div id="answer-slots-container"></div>
                    </div>
                    
                    <label>å³æ™‚é è¦½</label>
                    <div id="parsons-preview-container" style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #ddd; min-height: 200px;">
                        <p style="color: #999; text-align: center; margin: 2rem 0;">è«‹å…ˆè¨­å®šç¨‹å¼ç¢¼å¡Šå’Œç­”æ¡ˆå€ç©ºæ ¼</p>
                    </div>
                    
                    <p style="color: #666; font-size: 0.9rem; margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                        <strong>ğŸ“ èªªæ˜ï¼š</strong><br>
                        â€¢ å…ˆè¨­å®šæ‰€æœ‰å¯ä¾›é¸æ“‡çš„ç¨‹å¼ç¢¼å¡Šï¼ˆæ¨™è¨˜ç‚ºAã€Bã€C...ï¼‰<br>
                        â€¢ è¨­å®šç­”æ¡ˆå€æœ‰å¤šå°‘å€‹ç©ºæ ¼<br>
                        â€¢ ç‚ºæ¯å€‹ç©ºæ ¼é¸æ“‡é¡å‹ï¼š<strong>æ™®é€šç­”æ¡ˆ</strong>ï¼ˆå¾ç¨‹å¼ç¢¼å¡Šä¸­é¸æ“‡ï¼‰æˆ–<strong>å›ºå®šç¨‹å¼ç¢¼å¡Š</strong>ï¼ˆç›´æ¥è¼¸å…¥ç¨‹å¼ç¢¼ï¼‰<br>
                        â€¢ å›ºå®šç¨‹å¼ç¢¼å¡Šæœƒåœ¨ç­”é¡Œå€å›ºå®šé¡¯ç¤ºï¼Œå­¸ç”Ÿç„¡æ³•ä¿®æ”¹<br>
                        â€¢ å­¸ç”Ÿéœ€è¦å¾ç¨‹å¼ç¢¼å¡Šä¸­é¸æ“‡ä¸¦æŒ‰é †åºæ‹–æ‹‰åˆ°ç­”æ¡ˆå€å°æ‡‰çš„ç©ºæ ¼
                    </p>
                </div>
            `;
            // åˆå§‹åŒ–é¢„è§ˆå’Œå®Œæˆåº¦æ£€æŸ¥
            setTimeout(() => {
                updateAnswerSlots();
            }, 100);
            break;
            
        default:
            container.innerHTML = '';
    }
}

function addOption() {
    const container = document.getElementById('options-container');
    const isMultiple = document.getElementById('question-type').value === 'multiple_choice';
    const optionRow = document.createElement('div');
    optionRow.className = 'option-row';
    optionRow.style.cssText = 'display: flex; gap: 0.5rem; margin-bottom: 0.5rem;';
    optionRow.innerHTML = `
        <textarea class="option-input" placeholder="é¸é …å…§å®¹ (æ”¯æ´å¤šè¡Œå’ŒLaTeXå…¬å¼ï¼Œä¾‹å¦‚ï¼š$\\\\frac{1}{2}$)" style="flex: 1; min-height: 60px;"></textarea>
        <label style="margin: 0; display: flex; align-items: center;">
            <input type="${isMultiple ? 'checkbox' : 'radio'}" name="correct-option" style="margin-right: 0.5rem;">
            æ­£ç¢º
        </label>
        <button type="button" onclick="removeOption(this)" class="btn btn-danger" style="padding: 4px 8px;">åˆªé™¤</button>
    `;
    container.appendChild(optionRow);
}

function removeOption(button) {
    button.parentNode.remove();
}

function addDropdownOption() {
    const container = document.getElementById('dropdown-options-container');
    const optionRow = document.createElement('div');
    optionRow.className = 'dropdown-option-row';
    optionRow.style.cssText = 'display: flex; gap: 0.5rem; margin-bottom: 0.5rem;';
    optionRow.innerHTML = `
        <textarea class="dropdown-option-input" placeholder="é¸é …å…§å®¹ (æ”¯æ´å¤šè¡Œ)" style="flex: 1; min-height: 60px;"></textarea>
        <label style="margin: 0; display: flex; align-items: center;">
            <input type="radio" name="correct-dropdown" style="margin-right: 0.5rem;">
            æ­£ç¢º
        </label>
        <button type="button" onclick="removeDropdownOption(this)" class="btn btn-danger" style="padding: 4px 8px;">åˆªé™¤</button>
    `;
    container.appendChild(optionRow);
}

function removeDropdownOption(button) {
    button.parentNode.remove();
}

function addCodeBlock() {
    const container = document.getElementById('code-blocks-container');
    const blockCount = container.children.length;
    const blockLabel = String.fromCharCode(65 + blockCount); // A, B, C...
    const blockRow = document.createElement('div');
    blockRow.className = 'code-block-row';
    blockRow.style.cssText = 'display: flex; gap: 0.5rem; margin-bottom: 0.5rem; align-items: center;';
    blockRow.innerHTML = `
        <span style="min-width: 30px; color: #667eea; font-weight: bold;">${blockLabel}</span>
        <textarea class="code-block-input" placeholder="ç¨‹å¼ç¢¼å¡Šå…§å®¹ (æ”¯æ´å¤šè¡Œ)" style="flex: 1; min-height: 60px; font-family: Consolas, monospace;" oninput="updateAnswerSlots(); updateParsonsPreview();"></textarea>
        <button type="button" onclick="removeCodeBlock(this)" class="btn btn-danger" style="padding: 4px 8px;">åˆªé™¤</button>
    `;
    container.appendChild(blockRow);
    updateAnswerSlots();
    updateParsonsPreview();
}

function removeCodeBlock(button) {
    button.parentNode.remove();
    // é‡æ–°ç·¨è™Ÿ
    const container = document.getElementById('code-blocks-container');
    Array.from(container.children).forEach((row, index) => {
        const labelSpan = row.querySelector('span');
        if (labelSpan) labelSpan.textContent = String.fromCharCode(65 + index);
        // æ›´æ–°textareaçš„oninputäº‹ä»¶
        const textarea = row.querySelector('.code-block-input');
        if (textarea) {
            textarea.setAttribute('oninput', 'updateAnswerSlots(); updateParsonsPreview();');
        }
    });
    updateAnswerSlots();
    updateParsonsPreview();
}

function updateAnswerSlots() {
    const slotsCount = parseInt(document.getElementById('answer-slots-count').value) || 1;
    const container = document.getElementById('answer-slots-container');
    
    // ç²å–æ‰€æœ‰å¯ç”¨çš„ç¨‹å¼ç¢¼å¡Š
    const codeBlockInputs = document.querySelectorAll('.code-block-input');
    const codeBlocks = Array.from(codeBlockInputs).map((input, index) => {
        return {
            label: String.fromCharCode(65 + index),
            preview: input.value.substring(0, 30) + (input.value.length > 30 ? '...' : '')
        };
    });
    
    if (codeBlocks.length === 0) {
        container.innerHTML = '<p style="color: #e74c3c; margin: 0;">è«‹å…ˆæ·»åŠ ç¨‹å¼ç¢¼å¡Š</p>';
        return;
    }
    
    // ä¿å­˜ç¾æœ‰çš„é¸æ“‡ã€ç¸®æ’å’Œé¡å‹
    const currentSelections = {};
    const currentIndents = {};
    const currentTypes = {};
    const currentFixedContents = {};
    
    container.querySelectorAll('.slot-answer-select').forEach((select) => {
        const slotNum = select.dataset.slot;
        currentSelections[slotNum] = select.value;
    });
    container.querySelectorAll('.slot-indent-input').forEach((input) => {
        const slotNum = input.dataset.slot;
        currentIndents[slotNum] = input.value || '0';
    });
    container.querySelectorAll('input[name^="slot-type-"]:checked').forEach((radio) => {
        const slotNum = radio.name.replace('slot-type-', '');
        currentTypes[slotNum] = radio.value;
    });
    container.querySelectorAll('.slot-fixed-content').forEach((textarea) => {
        const slotNum = textarea.dataset.slot;
        currentFixedContents[slotNum] = textarea.value;
    });
    
    container.innerHTML = '';
    
    for (let i = 1; i <= slotsCount; i++) {
        const slotNum = i.toString();
        const slotType = currentTypes[slotNum] || 'answer';
        const slotDiv = document.createElement('div');
        slotDiv.className = 'slot-config-item';
        slotDiv.style.cssText = 'margin-bottom: 1rem; padding: 1rem; background: white; border-radius: 8px; border: 1px solid #ddd;';
        
        let slotHTML = `
            <div style="display: flex; align-items: center; margin-bottom: 0.8rem;">
            <label style="min-width: 80px; margin: 0; font-weight: bold; color: #333;">ç©ºæ ¼ ${i}ï¼š</label>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="radio" name="slot-type-${i}" value="answer" ${slotType === 'answer' ? 'checked' : ''} onchange="toggleSlotType('${i}'); updateParsonsPreview(); checkParsonsCompletion();" style="margin-right: 0.3rem;">
                        <span style="font-size: 0.9rem;">æ™®é€šç­”æ¡ˆ</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="radio" name="slot-type-${i}" value="fixed" ${slotType === 'fixed' ? 'checked' : ''} onchange="toggleSlotType('${i}'); updateParsonsPreview(); checkParsonsCompletion();" style="margin-right: 0.3rem;">
                        <span style="font-size: 0.9rem; color: #667eea;">å›ºå®šç¨‹å¼ç¢¼å¡Š</span>
                    </label>
                </div>
            </div>
        `;
        
        // æ ¹æ“šé¡å‹é¡¯ç¤ºä¸åŒçš„è¼¸å…¥æ§ä»¶
        if (slotType === 'fixed') {
            // å›ºå®šç¨‹å¼ç¢¼å¡Šï¼šé¡¯ç¤ºç¨‹å¼ç¢¼è¼¸å…¥æ¡†
            slotHTML += `
                <div class="slot-fixed-container" data-slot="${i}">
                    <label style="display: block; margin-bottom: 0.5rem; color: #666; font-size: 0.9rem;">ç¨‹å¼ç¢¼å…§å®¹ï¼š</label>
                    <textarea class="slot-fixed-content" data-slot="${i}" rows="3" placeholder="è¼¸å…¥å›ºå®šé¡¯ç¤ºçš„ç¨‹å¼ç¢¼..." style="width: 100%; font-family: Consolas, monospace; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;" oninput="updateParsonsPreview();">${currentFixedContents[i] || ''}</textarea>
                </div>
            `;
        } else {
            // æ™®é€šç­”æ¡ˆï¼šé¡¯ç¤ºä¸‹æ‹‰é¸æ“‡
            slotHTML += `
                <div class="slot-answer-container" data-slot="${i}">
                    <label style="display: block; margin-bottom: 0.5rem; color: #666; font-size: 0.9rem;">é¸æ“‡ç¨‹å¼ç¢¼å¡Šï¼š</label>
                    <select class="slot-answer-select" data-slot="${i}" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-family: Consolas, monospace;">
                <option value="">è«‹é¸æ“‡æ­£ç¢ºç­”æ¡ˆ...</option>
        `;
        
        codeBlocks.forEach(block => {
            const selected = currentSelections[i] === block.label ? 'selected' : '';
                slotHTML += `<option value="${block.label}" ${selected}>${block.label} - ${block.preview || '(ç©ºç™½)'}</option>`;
            });
            
            slotHTML += '</select></div>';
        }
        
        // ç¸®æ’è¨­ç½®ï¼ˆå…©ç¨®é¡å‹éƒ½æœ‰ï¼‰
        slotHTML += `
            <div style="display: flex; align-items: center; margin-top: 0.8rem;">
                <label style="min-width: 60px; margin: 0; color: #666; font-size: 0.9rem;">ç¸®æ’ï¼š</label>
                <input type="number" class="slot-indent-input" data-slot="${i}" min="0" max="10" value="${currentIndents[i] || '0'}" style="width: 80px; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;" title="ç¸®æ’ç´šåˆ¥ï¼ˆ0-10ï¼Œæ¯å€‹ç´šåˆ¥ç´„20pxï¼‰" onchange="updateParsonsPreview();">
            </div>
        `;
        
        slotDiv.innerHTML = slotHTML;
        
        // ç‚ºselectæ·»åŠ changeäº‹ä»¶ç›£è½
        const selectElement = slotDiv.querySelector('.slot-answer-select');
        if (selectElement) {
            selectElement.addEventListener('change', function() {
                updateParsonsPreview();
                checkParsonsCompletion();
            });
        }
        
        container.appendChild(slotDiv);
    }
    
    // åˆå§‹åŒ–é¢„è§ˆå’Œå®Œæˆåº¦æ£€æŸ¥
    updateParsonsPreview();
    checkParsonsCompletion();
}

// åˆ‡æ›æ§½ä½é¡å‹
function toggleSlotType(slotNum) {
    // é€šéç¸®æ’è¼¸å…¥æ¡†æ‰¾åˆ°å°æ‡‰çš„é…ç½®é …
    const indentInput = document.querySelector(`.slot-indent-input[data-slot="${slotNum}"]`);
    if (!indentInput) return;
    
    const slotDiv = indentInput.closest('.slot-config-item');
    if (!slotDiv) return;
    
    const typeRadio = slotDiv.querySelector(`input[name="slot-type-${slotNum}"]:checked`);
    if (!typeRadio) return;
    
    const selectedType = typeRadio.value;
    const answerContainer = slotDiv.querySelector('.slot-answer-container');
    const fixedContainer = slotDiv.querySelector('.slot-fixed-container');
    
    if (selectedType === 'fixed') {
        // åˆ‡æ›åˆ°å›ºå®šç¨‹å¼ç¢¼å¡Š
        if (answerContainer) {
            answerContainer.style.display = 'none';
        }
        if (!fixedContainer) {
            // å‰µå»ºå›ºå®šç¨‹å¼ç¢¼å¡Šè¼¸å…¥æ¡†
            const codeBlockInputs = document.querySelectorAll('.code-block-input');
            const codeBlocks = Array.from(codeBlockInputs).map((input, index) => {
                return {
                    label: String.fromCharCode(65 + index),
                    preview: input.value.substring(0, 30) + (input.value.length > 30 ? '...' : '')
                };
            });
            
            const indentInput = slotDiv.querySelector('.slot-indent-input');
            const indentDiv = indentInput.parentElement;
            
            const fixedHTML = `
                <div class="slot-fixed-container" data-slot="${slotNum}" style="margin-top: 0.8rem;">
                    <label style="display: block; margin-bottom: 0.5rem; color: #666; font-size: 0.9rem;">ç¨‹å¼ç¢¼å…§å®¹ï¼š</label>
                    <textarea class="slot-fixed-content" data-slot="${slotNum}" rows="3" placeholder="è¼¸å…¥å›ºå®šé¡¯ç¤ºçš„ç¨‹å¼ç¢¼..." style="width: 100%; font-family: Consolas, monospace; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;" oninput="updateParsonsPreview();"></textarea>
        </div>
    `;
            indentDiv.insertAdjacentHTML('beforebegin', fixedHTML);
        } else {
            fixedContainer.style.display = 'block';
        }
    } else {
        // åˆ‡æ›åˆ°æ™®é€šç­”æ¡ˆ
        if (fixedContainer) {
            fixedContainer.style.display = 'none';
        }
        if (!answerContainer) {
            // å‰µå»ºä¸‹æ‹‰é¸æ“‡æ¡†
            const codeBlockInputs = document.querySelectorAll('.code-block-input');
            const codeBlocks = Array.from(codeBlockInputs).map((input, index) => {
                return {
                    label: String.fromCharCode(65 + index),
                    preview: input.value.substring(0, 30) + (input.value.length > 30 ? '...' : '')
                };
            });
            
            const indentInput = slotDiv.querySelector('.slot-indent-input');
            const indentDiv = indentInput.parentElement;
            
            let selectHTML = `
                <div class="slot-answer-container" data-slot="${slotNum}" style="margin-top: 0.8rem;">
                    <label style="display: block; margin-bottom: 0.5rem; color: #666; font-size: 0.9rem;">é¸æ“‡ç¨‹å¼ç¢¼å¡Šï¼š</label>
                    <select class="slot-answer-select" data-slot="${slotNum}" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-family: Consolas, monospace;">
                        <option value="">è«‹é¸æ“‡æ­£ç¢ºç­”æ¡ˆ...</option>
            `;
            
            codeBlocks.forEach(block => {
                selectHTML += `<option value="${block.label}">${block.label} - ${block.preview || '(ç©ºç™½)'}</option>`;
            });
            
            selectHTML += '</select></div>';
            indentDiv.insertAdjacentHTML('beforebegin', selectHTML);
            
            // æ·»åŠ äº‹ä»¶ç›£è½
            const selectElement = slotDiv.querySelector('.slot-answer-select');
            if (selectElement) {
                selectElement.addEventListener('change', function() {
                    updateParsonsPreview();
                    checkParsonsCompletion();
                });
            }
        } else {
            answerContainer.style.display = 'block';
        }
    }
}

// æ³¨æ„ï¼šaddFixedBlock å’Œ removeFixedBlock å‡½æ•¸å·²ç§»é™¤
// å›ºå®šç¨‹å¼ç¢¼å¡Šç¾åœ¨ç›´æ¥åœ¨ç­”æ¡ˆæ§½ä½è¨­ç½®ä¸­ç®¡ç†

// å¯¦æ™‚é è¦½ç­”æ¡ˆå€æ•ˆæœ
function updateParsonsPreview() {
    const previewContainer = document.getElementById('parsons-preview-container');
    if (!previewContainer) return;
    
    const codeBlockInputs = document.querySelectorAll('.code-block-input');
    const slotConfigItems = document.querySelectorAll('.slot-config-item');
    
    // æ”¶é›†ç¨‹å¼ç¢¼å¡Š
    const codeBlocks = {};
    Array.from(codeBlockInputs).forEach((input, index) => {
        const label = String.fromCharCode(65 + index);
        const content = input.value.trim();
        if (content) {
            codeBlocks[label] = content;
        }
    });
    
    if (Object.keys(codeBlocks).length === 0 || slotConfigItems.length === 0) {
        previewContainer.innerHTML = '<p style="color: #999; text-align: center; margin: 2rem 0;">è«‹å…ˆè¨­å®šç¨‹å¼ç¢¼å¡Šå’Œç­”æ¡ˆå€ç©ºæ ¼</p>';
        return;
    }
    
    // ç”Ÿæˆé è¦½HTML
    let previewHTML = '<div style="display: flex; gap: 1rem; flex-direction: column;">';
    previewHTML += '<h4 style="margin: 0 0 0.5rem 0; color: #667eea; font-size: 0.9rem;">ç­”é¡Œå€é è¦½</h4>';
    
    Array.from(slotConfigItems).forEach((item) => {
        const indentInput = item.querySelector('.slot-indent-input');
        const slotNum = indentInput ? indentInput.dataset.slot : '';
        if (!slotNum) return;
        
        const indentLevel = indentInput ? (parseInt(indentInput.value) || 0) : 0;
        const indentPx = indentLevel * 20;
        
        // ç²å–é¡å‹
        const typeRadio = item.querySelector(`input[name="slot-type-${slotNum}"]:checked`);
        const slotType = typeRadio ? typeRadio.value : 'answer';
        
        previewHTML += '<div style="display: flex; align-items: center; margin-bottom: 0.5rem;">';
        previewHTML += `<span style="min-width: 60px; color: #666; font-size: 0.85rem;">ç©ºæ ¼ ${slotNum}ï¼š</span>`;
        previewHTML += `<div style="flex: 1; margin-left: ${indentPx}px; border: 2px dashed #bbb; border-radius: 6px; padding: 0.5rem; background: white; min-height: 40px; display: flex; align-items: center;">`;
        
        if (slotType === 'fixed') {
            const fixedContent = item.querySelector('.slot-fixed-content')?.value.trim() || '';
            if (fixedContent) {
                const preview = fixedContent.substring(0, 50) + (fixedContent.length > 50 ? '...' : '');
                previewHTML += `<span style="font-family: Consolas, monospace; font-size: 0.85rem; color: #2d3748; background: #f0f0f0; padding: 0.3rem 0.6rem; border-radius: 4px;">${preview}</span>`;
                previewHTML += '<span style="margin-left: 0.5rem; color: #667eea; font-size: 0.75rem;">[å›ºå®š]</span>';
            } else {
                previewHTML += '<span style="color: #999; font-style: italic; font-size: 0.85rem;">æœªè¼¸å…¥ç¨‹å¼ç¢¼</span>';
            }
        } else {
            const answerSelect = item.querySelector('.slot-answer-select');
            const selectedAnswer = answerSelect ? answerSelect.value : '';
            if (selectedAnswer && codeBlocks[selectedAnswer]) {
                const preview = codeBlocks[selectedAnswer].substring(0, 50) + (codeBlocks[selectedAnswer].length > 50 ? '...' : '');
                previewHTML += `<span style="font-family: Consolas, monospace; font-size: 0.85rem; color: #27ae60;">${preview}</span>`;
                previewHTML += `<span style="margin-left: 0.5rem; color: #27ae60; font-size: 0.75rem; font-weight: bold;">[${selectedAnswer}]</span>`;
            } else {
                previewHTML += '<span style="color: #999; font-style: italic; font-size: 0.85rem;">æœªè¨­å®š</span>';
            }
        }
        
        previewHTML += '</div>';
        previewHTML += '</div>';
    });
    
    previewHTML += '</div>';
    previewContainer.innerHTML = previewHTML;
}

// æª¢æŸ¥å®Œæˆåº¦
function checkParsonsCompletion() {
    const statusElement = document.getElementById('parsons-completion-status');
    if (!statusElement) return;
    
    const codeBlockInputs = document.querySelectorAll('.code-block-input');
    const slotConfigItems = document.querySelectorAll('.slot-config-item');
    
    // è¨ˆç®—å·²è¨­å®šçš„ç­”æ¡ˆå’Œå›ºå®šå€å¡Šæ•¸é‡
    let answeredCount = 0;
    let fixedCount = 0;
    const missingSlots = [];
    
    Array.from(slotConfigItems).forEach((item) => {
        const indentInput = item.querySelector('.slot-indent-input');
        const slotNum = indentInput ? indentInput.dataset.slot : '';
        if (!slotNum) return;
        
        const typeRadio = item.querySelector(`input[name="slot-type-${slotNum}"]:checked`);
        const slotType = typeRadio ? typeRadio.value : 'answer';
        
        if (slotType === 'fixed') {
            const fixedContent = item.querySelector('.slot-fixed-content')?.value.trim();
            if (fixedContent) {
                fixedCount++;
            } else {
                missingSlots.push(slotNum);
            }
        } else {
            const answerSelect = item.querySelector('.slot-answer-select');
            const answer = answerSelect ? answerSelect.value : '';
            if (answer) {
                answeredCount++;
            } else {
                missingSlots.push(slotNum);
            }
        }
    });
    
    const totalSlots = slotConfigItems.length;
    const codeBlocksCount = Array.from(codeBlockInputs).filter(input => input.value.trim()).length;
    const completedSlots = answeredCount + fixedCount;
    
    // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
    if (codeBlocksCount < 2) {
        statusElement.textContent = 'âš ï¸ è‡³å°‘éœ€è¦2å€‹ç¨‹å¼ç¢¼å¡Š';
        statusElement.style.background = '#fff3cd';
        statusElement.style.color = '#856404';
    } else if (completedSlots < totalSlots) {
        statusElement.textContent = `âš ï¸ é‚„æœ‰ ${totalSlots - completedSlots} å€‹ç©ºæ ¼æœªè¨­å®šï¼ˆç©ºæ ¼ï¼š${missingSlots.join(', ')}ï¼‰`;
        statusElement.style.background = '#fff3cd';
        statusElement.style.color = '#856404';
    } else {
        statusElement.textContent = 'âœ“ æ‰€æœ‰ç©ºæ ¼å·²è¨­å®šå®Œæˆ';
        statusElement.style.background = '#d4edda';
        statusElement.style.color = '#155724';
    }
}

// ä¸‹æ‹‰é¸å–®å¡«ç©ºé¡Œå‹å‡½æ•¸
function parseBlanks() {
    const fillblankText = document.getElementById('fillblank-text').value;
    const container = document.getElementById('blanks-options-container');
    
    // æ‰¾å‡ºæ‰€æœ‰ {{ '{{}}' }} æ¨™è¨˜
    const blanks = fillblankText.match(/\{\{[^}]*\}\}/g) || [];
    
    if (blanks.length === 0) {
        alert('è«‹å…ˆåœ¨é¡Œç›®æ–‡å­—ä¸­ä½¿ç”¨ {{ '{{}}' }} æ¨™è¨˜å¡«ç©ºä½ç½®');
        return;
    }
    
    container.innerHTML = '';
    
    blanks.forEach((blank, index) => {
        const blankDiv = document.createElement('div');
        blankDiv.style.cssText = 'border: 1px solid #ddd; border-radius: 6px; padding: 1rem; margin-bottom: 1rem; background: white;';
        
        blankDiv.innerHTML = `
            <h4 style="margin: 0 0 1rem 0; color: #333;">ç©ºæ ¼ ${index + 1}: ${blank}</h4>
            <div class="blank-options" data-blank-index="${index}">
                <div class="blank-option-row" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem; align-items: center;">
                    <textarea class="blank-option-input" placeholder="é¸é …å…§å®¹ (æ”¯æ´å¤šè¡Œ)" style="flex: 1; min-height: 60px;"></textarea>
                    <label style="margin: 0; display: flex; align-items: center;">
                        <input type="radio" name="correct-blank-${index}" style="margin-right: 0.5rem;">
                        æ­£ç¢ºç­”æ¡ˆ
                    </label>
                    <button type="button" onclick="removeBlankOption(this)" class="btn btn-danger" style="padding: 4px 8px;">åˆªé™¤</button>
                </div>
            </div>
            <button type="button" onclick="addBlankOption(${index})" class="btn btn-secondary" style="margin-top: 0.5rem;">æ–°å¢é¸é …</button>
        `;
        
        container.appendChild(blankDiv);
    });
}

function addBlankOption(blankIndex) {
    const container = document.querySelector(`[data-blank-index="${blankIndex}"]`);
    const optionRow = document.createElement('div');
    optionRow.className = 'blank-option-row';
    optionRow.style.cssText = 'display: flex; gap: 0.5rem; margin-bottom: 0.5rem; align-items: center;';
    optionRow.innerHTML = `
        <textarea class="blank-option-input" placeholder="é¸é …å…§å®¹ (æ”¯æ´å¤šè¡Œ)" style="flex: 1; min-height: 60px;"></textarea>
        <label style="margin: 0; display: flex; align-items: center;">
            <input type="radio" name="correct-blank-${blankIndex}" style="margin-right: 0.5rem;">
            æ­£ç¢ºç­”æ¡ˆ
        </label>
        <button type="button" onclick="removeBlankOption(this)" class="btn btn-danger" style="padding: 4px 8px;">åˆªé™¤</button>
    `;
    container.appendChild(optionRow);
}

function removeBlankOption(button) {
    button.parentNode.remove();
}

// è¡¨å–®æäº¤
document.getElementById('question-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = collectFormData();
    if (!validateFormData(formData)) return;
    
    try {
        const url = currentQuestionId ? 
            `/api/question/${currentQuestionId}` : 
            `/api/quiz-bank/{{ quiz_bank.id }}/questions`;
        const method = currentQuestionId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            alert(result.message);
            hideQuestionModal();
            location.reload();
        } else {
            alert(result.error || 'æ“ä½œå¤±æ•—');
        }
    } catch (error) {
        alert('ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
});

function collectFormData() {
    const title = document.getElementById('question-title').value;
    const text = document.getElementById('question-text').value;
    const type = document.getElementById('question-type').value;
    const points = parseInt(document.getElementById('question-points').value);
    
    const questionData = {};
    
    switch (type) {
        case 'single_choice':
        case 'multiple_choice':
            const optionInputs = document.querySelectorAll('.option-input');
            const correctInputs = document.querySelectorAll('input[name="correct-option"]:checked');
            
            questionData.options = Array.from(optionInputs).map(input => input.value);
            
            if (type === 'single_choice') {
                const correctIndex = Array.from(document.querySelectorAll('input[name="correct-option"]')).findIndex(input => input.checked);
                questionData.correct_answer = correctIndex >= 0 ? questionData.options[correctIndex] : '';
            } else {
                const correctIndices = Array.from(correctInputs).map(input => {
                    return Array.from(document.querySelectorAll('input[name="correct-option"]')).indexOf(input);
                });
                questionData.correct_answers = correctIndices.map(index => questionData.options[index]);
            }
            break;
            
        case 'fill_blank':
            questionData.correct_answer = document.getElementById('correct-answer').value;
            break;
            
        case 'dropdown':
            const dropdownInputs = document.querySelectorAll('.dropdown-option-input');
            const correctDropdown = document.querySelector('input[name="correct-dropdown"]:checked');
            
            questionData.options = Array.from(dropdownInputs).map(input => input.value);
            
            if (correctDropdown) {
                const correctIndex = Array.from(document.querySelectorAll('input[name="correct-dropdown"]')).indexOf(correctDropdown);
                questionData.correct_answer = questionData.options[correctIndex];
            }
            break;
            
        case 'dropdown_fillblank':
            const fillblankText = document.getElementById('fillblank-text').value;
            questionData.fillblank_text = fillblankText;
            
            // æ”¶é›†æ¯å€‹ç©ºæ ¼çš„é¸é …å’Œæ­£ç¢ºç­”æ¡ˆ
            const blanksData = [];
            const blankContainers = document.querySelectorAll('[data-blank-index]');
            
            blankContainers.forEach((container, index) => {
                const blankIndex = container.getAttribute('data-blank-index');
                const optionInputs = container.querySelectorAll('.blank-option-input');
                const correctInput = container.querySelector(`input[name="correct-blank-${blankIndex}"]:checked`);
                
                const options = Array.from(optionInputs).map(input => input.value.trim()).filter(v => v);
                let correctAnswer = '';
                
                if (correctInput) {
                    const correctIndex = Array.from(container.querySelectorAll(`input[name="correct-blank-${blankIndex}"]`)).indexOf(correctInput);
                    correctAnswer = options[correctIndex] || '';
                }
                
                blanksData.push({
                    options: options,
                    correct_answer: correctAnswer
                });
            });
            
            questionData.blanks = blanksData;
            break;
            
        case 'parsons':
            const codeBlockInputs = document.querySelectorAll('.code-block-input');
            const slotConfigItems = document.querySelectorAll('.slot-config-item');
            
            // æ”¶é›†æ‰€æœ‰ç¨‹å¼ç¢¼å¡Šï¼Œä½¿ç”¨æ¨™ç±¤(A, B, C...)ä½œç‚ºkey
            const codeBlocks = {};
            Array.from(codeBlockInputs).forEach((input, index) => {
                const label = String.fromCharCode(65 + index);
                const content = input.value.trim();
                if (content) {
                    codeBlocks[label] = content;
                }
            });
            
            // æ”¶é›†ç­”æ¡ˆå€ç©ºæ ¼çš„æ­£ç¢ºç­”æ¡ˆã€ç¸®æ’å’Œå›ºå®šå€å¡Š
            const slotAnswers = {};
            const slotIndents = {};
            const fixedBlocks = {};
            
            // éæ­·æ¯å€‹æ§½ä½é…ç½®
            Array.from(slotConfigItems).forEach((item) => {
                const slotNumber = item.querySelector('.slot-indent-input')?.dataset.slot;
                if (!slotNumber) return;
                
                // ç²å–é¡å‹
                const typeRadio = item.querySelector(`input[name="slot-type-${slotNumber}"]:checked`);
                const slotType = typeRadio ? typeRadio.value : 'answer';
                
                // ç²å–ç¸®æ’
                const indentInput = item.querySelector('.slot-indent-input');
                const indentLevel = indentInput ? (parseInt(indentInput.value) || 0) : 0;
                slotIndents[slotNumber] = indentLevel;
                
                if (slotType === 'fixed') {
                    // å›ºå®šç¨‹å¼ç¢¼å¡Š
                    const fixedContent = item.querySelector('.slot-fixed-content')?.value.trim();
                    if (fixedContent) {
                        fixedBlocks[slotNumber] = {
                            content: fixedContent,
                            display_label: false,
                            indent: indentLevel
                        };
                    }
                } else {
                    // æ™®é€šç­”æ¡ˆ
                    const answerSelect = item.querySelector('.slot-answer-select');
                    const answer = answerSelect ? answerSelect.value : '';
                    if (answer) {
                        slotAnswers[slotNumber] = answer;
                    }
                }
            });
            
            questionData.code_blocks = codeBlocks; // {A: "code1", B: "code2", C: "code3"}
            questionData.answer_slots = slotConfigItems.length; // ç­”æ¡ˆå€ç©ºæ ¼æ•¸é‡
            questionData.slot_answers = slotAnswers; // {1: "A", 3: "B"} - ä¸åŒ…å«å›ºå®šå€å¡Šçš„ä½ç½®
            questionData.slot_indents = slotIndents; // {1: 0, 2: 1, 3: 2} ç¸®æ’ç´šåˆ¥ï¼ˆåŒ…å«æ‰€æœ‰æ§½ä½ï¼‰
            questionData.fixed_blocks = fixedBlocks; // {2: {content: "...", display_label: false, indent: 1}}
            break;
    }
    
    return {
        title,
        question_text: text,
        question_type: type,
        points,
        question_data: questionData
    };
}

function validateFormData(data) {
    if (!data.title || !data.question_text || !data.question_type) {
        alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½');
        return false;
    }
    
    switch (data.question_type) {
        case 'single_choice':
        case 'multiple_choice':
            if (!data.question_data.options || data.question_data.options.length < 2) {
                alert('è‡³å°‘éœ€è¦2å€‹é¸é …');
                return false;
            }
            if (data.question_type === 'single_choice' && !data.question_data.correct_answer) {
                alert('è«‹é¸æ“‡æ­£ç¢ºç­”æ¡ˆ');
                return false;
            }
            if (data.question_type === 'multiple_choice' && (!data.question_data.correct_answers || data.question_data.correct_answers.length === 0)) {
                alert('è«‹é¸æ“‡è‡³å°‘ä¸€å€‹æ­£ç¢ºç­”æ¡ˆ');
                return false;
            }
            break;
            
        case 'fill_blank':
            if (!data.question_data.correct_answer) {
                alert('è«‹è¼¸å…¥æ­£ç¢ºç­”æ¡ˆ');
                return false;
            }
            break;
            
        case 'dropdown':
            if (!data.question_data.options || data.question_data.options.length < 2) {
                alert('è‡³å°‘éœ€è¦2å€‹é¸é …');
                return false;
            }
            if (!data.question_data.correct_answer) {
                alert('è«‹é¸æ“‡æ­£ç¢ºç­”æ¡ˆ');
                return false;
            }
            break;
            
        case 'dropdown_fillblank':
            if (!data.question_data.fillblank_text) {
                alert('è«‹è¼¸å…¥å¡«ç©ºé¡Œç›®æ–‡å­—');
                return false;
            }
            if (!data.question_data.blanks || data.question_data.blanks.length === 0) {
                alert('è«‹å…ˆè§£æç©ºæ ¼ä¸¦è¨­å®šé¸é …');
                return false;
            }
            
            // æª¢æŸ¥æ¯å€‹ç©ºæ ¼æ˜¯å¦éƒ½æœ‰é¸é …å’Œæ­£ç¢ºç­”æ¡ˆ
            for (let i = 0; i < data.question_data.blanks.length; i++) {
                const blank = data.question_data.blanks[i];
                if (!blank.options || blank.options.length < 2) {
                    alert(`ç©ºæ ¼ ${i + 1} è‡³å°‘éœ€è¦2å€‹é¸é …`);
                    return false;
                }
                if (!blank.correct_answer) {
                    alert(`ç©ºæ ¼ ${i + 1} è«‹é¸æ“‡æ­£ç¢ºç­”æ¡ˆ`);
                    return false;
                }
            }
            break;
            
        case 'parsons':
            if (!data.question_data.code_blocks || Object.keys(data.question_data.code_blocks).length < 2) {
                alert('âŒ è‡³å°‘éœ€è¦2å€‹ç¨‹å¼ç¢¼å¡Šæ‰èƒ½å»ºç«‹ç¨‹å¼ç¢¼æ’åºé¡Œ');
                return false;
            }
            
            // æª¢æŸ¥æ˜¯å¦æ‰€æœ‰ç©ºæ ¼éƒ½æœ‰è¨­å®šï¼ˆæ™®é€šç­”æ¡ˆæˆ–å›ºå®šç¨‹å¼ç¢¼å¡Šï¼‰
            const totalSlots = data.question_data.answer_slots;
            const answeredSlots = data.question_data.slot_answers || {};
            const fixedBlocks = data.question_data.fixed_blocks || {};
            
            // æ‰¾å‡ºç¼ºå°‘è¨­å®šçš„ç©ºæ ¼
            const missingSlots = [];
            for (let i = 1; i <= totalSlots; i++) {
                const slotNum = i.toString();
                if (!answeredSlots[slotNum] && !fixedBlocks[slotNum]) {
                    missingSlots.push(slotNum);
                }
            }
            
            if (missingSlots.length > 0) {
                const missingList = missingSlots.join('ã€');
                alert(`âŒ ä»¥ä¸‹ç©ºæ ¼å°šæœªè¨­å®šï¼šç©ºæ ¼ ${missingList}\n\nè«‹ç‚ºæ¯å€‹ç©ºæ ¼é¸æ“‡ã€Œæ™®é€šç­”æ¡ˆã€æˆ–ã€Œå›ºå®šç¨‹å¼ç¢¼å¡Šã€ã€‚`);
                // é«˜äº®é¡¯ç¤ºç¼ºå°‘è¨­å®šçš„ç©ºæ ¼
                setTimeout(() => {
                    missingSlots.forEach(slotNum => {
                        const indentInput = document.querySelector(`.slot-indent-input[data-slot="${slotNum}"]`);
                        if (indentInput) {
                            const slotItem = indentInput.closest('.slot-config-item');
                            if (slotItem) {
                                slotItem.style.borderColor = '#e74c3c';
                                slotItem.style.borderWidth = '2px';
                                slotItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                setTimeout(() => {
                                    slotItem.style.borderColor = '';
                                    slotItem.style.borderWidth = '';
                                }, 3000);
                            }
                        }
                    });
                }, 100);
                return false;
            }
            
            // æª¢æŸ¥å›ºå®šç¨‹å¼ç¢¼å¡Šæ˜¯å¦æœ‰å…§å®¹
            const emptyFixedBlocks = [];
            Object.keys(fixedBlocks).forEach(slotNum => {
                const fixed = fixedBlocks[slotNum];
                if (!fixed.content || !fixed.content.trim()) {
                    emptyFixedBlocks.push(slotNum);
                }
            });
            
            if (emptyFixedBlocks.length > 0) {
                alert(`âŒ ä»¥ä¸‹å›ºå®šç¨‹å¼ç¢¼å¡Šæœªè¼¸å…¥å…§å®¹ï¼šç©ºæ ¼ ${emptyFixedBlocks.join('ã€')}\n\nè«‹è¼¸å…¥å›ºå®šç¨‹å¼ç¢¼å¡Šçš„å…§å®¹ã€‚`);
                return false;
            }
            
            break;
    }
    
    return true;
}

async function editQuestion(questionId) {
    currentQuestionId = questionId;
    document.getElementById('modal-title').textContent = 'ç·¨è¼¯é¡Œç›®';
    
    try {
        // å¾APIç²å–é¡Œç›®æ•¸æ“š
        const response = await fetch(`/api/quiz-bank/{{ quiz_bank.id }}/questions`);
        const questions = await response.json();
        
        // æ‰¾åˆ°è¦ç·¨è¼¯çš„é¡Œç›®
        const question = questions.find(q => q.id === questionId);
        if (!question) {
            alert('æ‰¾ä¸åˆ°é¡Œç›®æ•¸æ“š');
            return;
        }
        
        // å¡«å……åŸºæœ¬ä¿¡æ¯
        document.getElementById('question-title').value = question.title;
        document.getElementById('question-text').value = question.question_text;
        document.getElementById('question-type').value = question.question_type;
        document.getElementById('question-points').value = question.points;
        
        // è§¸ç™¼é¡å‹è®Šæ›´äº‹ä»¶ä»¥ç”Ÿæˆå°æ‡‰çš„è¡¨å–®
        handleQuestionTypeChange();
        
        // æ ¹æ“šé¡Œç›®é¡å‹å¡«å……ç‰¹å®šå…§å®¹
        if (question.question_data) {
            const data = question.question_data;
            
            switch (question.question_type) {
                case 'single_choice':
                case 'multiple_choice':
                    // æ¸…ç©ºç¾æœ‰é¸é …
                    document.getElementById('options-container').innerHTML = '';
                    
                    // æ·»åŠ é¸é …
                    if (data.options && data.options.length > 0) {
                        data.options.forEach(option => {
                            const optionRow = document.createElement('div');
                            optionRow.className = 'option-row';
                            optionRow.style.cssText = 'display: flex; gap: 0.5rem; margin-bottom: 0.5rem;';
                            
                            const isCorrect = question.question_type === 'single_choice' 
                                ? option === data.correct_answer
                                : (data.correct_answers && data.correct_answers.includes(option));
                            
                            optionRow.innerHTML = `
                                <textarea class="option-input" placeholder="é¸é …å…§å®¹ (æ”¯æ´å¤šè¡Œ)" style="flex: 1; min-height: 60px;">${option}</textarea>
                                <label style="margin: 0; display: flex; align-items: center;">
                                    <input type="${question.question_type === 'single_choice' ? 'radio' : 'checkbox'}" 
                                           name="correct-option" style="margin-right: 0.5rem;" ${isCorrect ? 'checked' : ''}>
                                    æ­£ç¢º
                                </label>
                                <button type="button" onclick="removeOption(this)" class="btn btn-danger" style="padding: 4px 8px;">åˆªé™¤</button>
                            `;
                            
                            document.getElementById('options-container').appendChild(optionRow);
                        });
                    }
                    break;
                    
                case 'fill_blank':
                    if (data.correct_answer) {
                        document.getElementById('correct-answer').value = data.correct_answer;
                    }
                    break;
                    
                case 'dropdown':
                    // æ¸…ç©ºç¾æœ‰é¸é …
                    document.getElementById('dropdown-options-container').innerHTML = '';
                    
                    // æ·»åŠ é¸é …
                    if (data.options && data.options.length > 0) {
                        data.options.forEach(option => {
                            const optionRow = document.createElement('div');
                            optionRow.className = 'dropdown-option-row';
                            optionRow.style.cssText = 'display: flex; gap: 0.5rem; margin-bottom: 0.5rem;';
                            
                            const isCorrect = option === data.correct_answer;
                            
                            optionRow.innerHTML = `
                                <textarea class="dropdown-option-input" placeholder="é¸é …å…§å®¹ (æ”¯æ´å¤šè¡Œ)" style="flex: 1; min-height: 60px;">${option}</textarea>
                                <label style="margin: 0; display: flex; align-items: center;">
                                    <input type="radio" name="correct-dropdown" style="margin-right: 0.5rem;" ${isCorrect ? 'checked' : ''}>
                                    æ­£ç¢º
                                </label>
                                <button type="button" onclick="removeDropdownOption(this)" class="btn btn-danger" style="padding: 4px 8px;">åˆªé™¤</button>
                            `;
                            
                            document.getElementById('dropdown-options-container').appendChild(optionRow);
                        });
                    }
                    break;
                    
                case 'dropdown_fillblank':
                    // å¡«å……é¡Œç›®æ–‡å­—
                    if (data.fillblank_text) {
                        document.getElementById('fillblank-text').value = data.fillblank_text;
                    }
                    
                    // è§£æç©ºæ ¼
                    parseBlanks();
                    
                    // å¡«å……ç©ºæ ¼é¸é …
                    if (data.blanks && data.blanks.length > 0) {
                        setTimeout(() => {
                            data.blanks.forEach((blank, index) => {
                                const blankContainer = document.querySelector(`[data-blank-index="${index}"]`);
                                if (!blankContainer) return;
                                
                                // æ¸…ç©ºç¾æœ‰é¸é …
                                blankContainer.innerHTML = '';
                                
                                // æ·»åŠ é¸é …
                                if (blank.options && blank.options.length > 0) {
                                    blank.options.forEach(option => {
                                        const optionRow = document.createElement('div');
                                        optionRow.className = 'blank-option-row';
                                        optionRow.style.cssText = 'display: flex; gap: 0.5rem; margin-bottom: 0.5rem; align-items: center;';
                                        
                                        const isCorrect = option === blank.correct_answer;
                                        
                                        optionRow.innerHTML = `
                                            <textarea class="blank-option-input" placeholder="é¸é …å…§å®¹ (æ”¯æ´å¤šè¡Œ)" style="flex: 1; min-height: 60px;">${option}</textarea>
                                            <label style="margin: 0; display: flex; align-items: center;">
                                                <input type="radio" name="correct-blank-${index}" style="margin-right: 0.5rem;" ${isCorrect ? 'checked' : ''}>
                                                æ­£ç¢ºç­”æ¡ˆ
                                            </label>
                                            <button type="button" onclick="removeBlankOption(this)" class="btn btn-danger" style="padding: 4px 8px;">åˆªé™¤</button>
                                        `;
                                        
                                        blankContainer.appendChild(optionRow);
                                    });
                                }
                            });
                        }, 100); // å»¶é²ä¸€ä¸‹ä»¥ç¢ºä¿ç©ºæ ¼å®¹å™¨å·²ç¶“ç”Ÿæˆ
                    }
                    break;
                    
                case 'parsons':
                    // æ¸…ç©ºç¾æœ‰ç¨‹å¼ç¢¼å¡Š
                    const codeBlocksContainer = document.getElementById('code-blocks-container');
                    codeBlocksContainer.innerHTML = '';
                    
                    let codeBlocks = data.code_blocks || {};
                    let answerSlots = data.answer_slots || Object.keys(data.code_blocks).length;
                    let slotAnswers = data.slot_answers || {};
                    let slotIndents = data.slot_indents || {};
                    let fixedBlocks = data.fixed_blocks || {};
                    
                    // æ·»åŠ ç¨‹å¼ç¢¼å¡Š
                    const labels = Object.keys(codeBlocks).sort();
                    labels.forEach((label, index) => {
                        const blockRow = document.createElement('div');
                        blockRow.className = 'code-block-row';
                        blockRow.style.cssText = 'display: flex; gap: 0.5rem; margin-bottom: 0.5rem; align-items: center;';
                        blockRow.innerHTML = `
                            <span style="min-width: 30px; color: #667eea; font-weight: bold;">${label}</span>
                            <textarea class="code-block-input" placeholder="ç¨‹å¼ç¢¼å¡Šå…§å®¹ (æ”¯æ´å¤šè¡Œ)" style="flex: 1; min-height: 60px; font-family: Consolas, monospace;" oninput="updateAnswerSlots(); updateParsonsPreview();">${codeBlocks[label]}</textarea>
                            <button type="button" onclick="removeCodeBlock(this)" class="btn btn-danger" style="padding: 4px 8px;">åˆªé™¤</button>
                        `;
                        codeBlocksContainer.appendChild(blockRow);
                    });
                    
                    // è¨­å®šç­”æ¡ˆå€ç©ºæ ¼æ•¸é‡
                    document.getElementById('answer-slots-count').value = answerSlots;
                    
                    // æ›´æ–°ç­”æ¡ˆå€ç©ºæ ¼ï¼ˆæœƒè‡ªå‹•ä½¿ç”¨slotAnswerså¡«å……ï¼‰
                    setTimeout(() => {
                        updateAnswerSlots();
                        
                        // è¨­å®šæ¯å€‹ç©ºæ ¼çš„é¡å‹å’Œå…§å®¹
                        setTimeout(() => {
                            // å…ˆè¨­å®šå›ºå®šå€å¡Š
                            Object.keys(fixedBlocks).forEach(slotNum => {
                                const fixed = fixedBlocks[slotNum];
                                const typeRadio = document.querySelector(`input[name="slot-type-${slotNum}"][value="fixed"]`);
                                if (typeRadio) {
                                    typeRadio.checked = true;
                                    toggleSlotType(slotNum);
                                    
                                    // è¨­å®šå›ºå®šç¨‹å¼ç¢¼å…§å®¹
                                    setTimeout(() => {
                                        const fixedContent = document.querySelector(`.slot-fixed-content[data-slot="${slotNum}"]`);
                                        if (fixedContent) {
                                            fixedContent.value = fixed.content || '';
                                        }
                                        
                                        // è¨­å®šç¸®æ’
                                        const indentInput = document.querySelector(`.slot-indent-input[data-slot="${slotNum}"]`);
                                        if (indentInput && fixed.indent !== undefined) {
                                            indentInput.value = fixed.indent;
                                        }
                                        
                                        updateParsonsPreview();
                                        checkParsonsCompletion();
                                    }, 50);
                                }
                            });
                            
                            // è¨­å®šæ™®é€šç­”æ¡ˆ
                        Object.keys(slotAnswers).forEach(slotNum => {
                                // ç¢ºä¿é¡å‹æ˜¯æ™®é€šç­”æ¡ˆ
                                const typeRadio = document.querySelector(`input[name="slot-type-${slotNum}"][value="answer"]`);
                                if (typeRadio) {
                                    typeRadio.checked = true;
                                    toggleSlotType(slotNum);
                                    
                                    setTimeout(() => {
                            const select = document.querySelector(`.slot-answer-select[data-slot="${slotNum}"]`);
                            if (select) {
                                select.value = slotAnswers[slotNum];
                            }
                                        
                                        // è¨­å®šç¸®æ’
                                        const indentInput = document.querySelector(`.slot-indent-input[data-slot="${slotNum}"]`);
                                        if (indentInput && slotIndents[slotNum] !== undefined) {
                                            indentInput.value = slotIndents[slotNum];
                                        }
                                        
                                        updateParsonsPreview();
                                        checkParsonsCompletion();
                                    }, 50);
                                }
                            });
                            
                            // è¨­å®šå…¶ä»–ç©ºæ ¼çš„ç¸®æ’ï¼ˆå¦‚æœæ²’æœ‰è¨­å®šç­”æ¡ˆæˆ–å›ºå®šå€å¡Šï¼‰
                            Object.keys(slotIndents).forEach(slotNum => {
                                if (!fixedBlocks[slotNum] && !slotAnswers[slotNum]) {
                                    const indentInput = document.querySelector(`.slot-indent-input[data-slot="${slotNum}"]`);
                                    if (indentInput) {
                                        indentInput.value = slotIndents[slotNum];
                                    }
                                }
                            });
                            
                            updateParsonsPreview();
                            checkParsonsCompletion();
                        }, 100);
                    }, 100);
                    
                    break;
            }
        }
        
        // é¡¯ç¤ºæ¨¡æ…‹æ¡†
        document.getElementById('question-modal').style.display = 'block';
        
    } catch (error) {
        console.error('ç²å–é¡Œç›®æ•¸æ“šå¤±æ•—', error);
        alert('ç²å–é¡Œç›®æ•¸æ“šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
}

async function deleteQuestion(questionId) {
    if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹é¡Œç›®å—ï¼Ÿ')) return;
    
    try {
        const response = await fetch(`/api/question/${questionId}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (response.ok) {
            alert(result.message);
            location.reload();
        } else {
            alert(result.error || 'åˆªé™¤å¤±æ•—');
        }
    } catch (error) {
        alert('ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
}

// é‡æ–°æ¸²æŸ“ MathJaxï¼Œç•¶é é¢è¼‰å…¥æ™‚
document.addEventListener('DOMContentLoaded', function() {
    if (typeof MathJax !== 'undefined') {
        MathJax.typesetPromise().catch((err) => console.log('MathJax typeset error:', err));
    }
});

</script>

{% endblock %}
