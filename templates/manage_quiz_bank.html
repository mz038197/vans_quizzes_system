{% extends "base.html" %}

{% block title %}管理題庫 - {{ quiz_bank.title }}{% endblock %}

{% block content %}
<div>
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <div>
            <h1 style="color: #333; margin-bottom: 0.5rem;">📝 {{ quiz_bank.title }}</h1>
            <p style="color: #666;">題庫代碼：<span class="access-code">{{ quiz_bank.access_code }}</span></p>
        </div>
        <div style="display: flex; gap: 1rem;">
            <button onclick="showAddQuestionModal()" class="btn">➕ 新增題目</button>
            <a href="{{ url_for('view_submissions_page', quiz_bank_id=quiz_bank.id) }}" class="btn btn-secondary">📊 查看成績</a>
            <a href="{{ url_for('teacher_dashboard') }}" class="btn btn-secondary">← 返回</a>
        </div>
    </div>
    
    <div id="questions-container">
        {% if questions %}
            {% for question in questions %}
            <div class="question-item" data-question-id="{{ question.id }}">
                <div class="question-header">
                    <div>
                        <strong>{{ question.title }}</strong>
                        <span class="question-type-badge">{{ get_question_type_name(question.question_type) }}</span>
                        <span style="color: #666; margin-left: 1rem;">{{ question.points }} 分</span>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button onclick="editQuestion({{ question.id }})" class="btn" style="padding: 6px 12px;">✏️ 編輯</button>
                        <button onclick="deleteQuestion({{ question.id }})" class="btn btn-danger" style="padding: 6px 12px;">🗑️ 刪除</button>
                    </div>
                </div>
                <div class="question-content">
                    <p style="white-space: pre-wrap;">{{ question.question_text | trim }}</p>
                    {% if question.question_data %}
                        {% set data = question.question_data | from_json %}
                        {% if question.question_type in ['single_choice', 'multiple_choice'] %}
                            <div style="margin-top: 1rem;">
                                {% for option in data.options %}
                                <div class="option" style="background: #f8f9fa;">
                                    <div class="option-text">{{ option }}</div>
                                    {% if (question.question_type == 'single_choice' and option == data.correct_answer) or 
                                           (question.question_type == 'multiple_choice' and option in data.correct_answers) %}
                                    <div class="option-correct">✓ 正確答案</div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        {% elif question.question_type == 'fill_blank' %}
                            <div style="margin-top: 1rem; color: #27ae60;">
                                <strong>正確答案：</strong> {{ data.correct_answer }}
                            </div>
                        {% elif question.question_type == 'dropdown' %}
                            <div style="margin-top: 1rem;">
                                <strong>選項：</strong> {{ data.options | join(', ') }}<br>
                                <strong style="color: #27ae60;">正確答案：</strong> {{ data.correct_answer }}
                            </div>
                        {% elif question.question_type == 'dropdown_fillblank' %}
                            <div style="margin-top: 1rem;">
                                <div style="background: #f8f9fa; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                                    <strong>題目文字：</strong>
                                    <div style="margin-top: 0.5rem; font-family: monospace;">{{ data.fillblank_text }}</div>
                                </div>
                                <strong>空格設定：</strong>
                                {% for blank in data.blanks %}
                                <div style="border: 1px solid #ddd; border-radius: 4px; padding: 0.8rem; margin: 0.5rem 0; background: white;">
                                    <div style="font-weight: bold; color: #666; margin-bottom: 0.5rem;">空格 {{ loop.index }}:</div>
                                    <div style="margin-bottom: 0.5rem;">
                                        <strong>選項：</strong> {{ blank.options | join(', ') }}
                                    </div>
                                    <div style="color: #27ae60;">
                                        <strong>正確答案：</strong> {{ blank.correct_answer }}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% elif question.question_type == 'parsons' %}
                            <div style="margin-top: 1rem;">
                                <div class="parsons-preview-container" style="display: flex; gap: 2rem; margin-top: 1rem;">
                                    <div class="parsons-preview-bank" style="flex: 1; border: 2px dashed #ddd; border-radius: 8px; padding: 1rem; background: #fafafa;">
                                        <h4 style="text-align: center; margin-bottom: 1rem; color: #666; font-size: 1rem;">可選程式碼塊</h4>
                                        {% for label in data.code_blocks.keys() | sort %}
                                        <div class="code-block-preview" style="background: #2d3748; color: #e2e8f0; padding: 0.4rem 1rem; margin: 0.3rem 0; border-radius: 6px; font-family: 'Courier New', monospace;  line-height: 1.4; font-size: 14px; overflow-x: auto; box-shadow: 0 2px 4px rgba(0,0,0,0.1); height: auto; min-height: 0;">
                                            <div style="display: flex; align-items: flex-start;">
                                                <span style="color: #667eea; font-weight: bold; margin-right: 0.5rem; display: inline-block; width: 20px; text-align: center; flex-shrink: 0;">{{ label }}</span>
                                                <div style="text-align: left; flex-grow: 1;white-space: pre-wrap;">{{ data.code_blocks[label] | safe }}</div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    <div class="parsons-preview-target" style="flex: 1; border: 2px dashed #667eea; border-radius: 8px; padding: 1rem; background: #f8f9ff;">
                                        <h4 style="text-align: center; margin-bottom: 1rem; color: #667eea; font-size: 1rem;">答題區 (共 {{ data.answer_slots }} 個空格)</h4>
                                        {% for i in range(1, data.answer_slots + 1) %}
                                        {% set correct_label = data.slot_answers.get(i|string, '') %}
                                        <div class="answer-slot-preview" style="border: 2px dashed #bbb; border-radius: 8px; margin: 0.5rem 0; min-height: 60px; display: flex; align-items: center; padding: 0.5rem; background: white;">
                                            <div class="slot-number" style="min-width: 30px; height: 30px; background: #667eea; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.9rem; margin-right: 1rem;">{{ i }}</div>
                                            {% if correct_label %}
                                            <div class="answer-block" style="flex: 1; background: #e8f5e8; color: #2d3748; padding: 0.4rem 1rem; border-radius: 6px; font-family: 'Courier New', monospace; line-height: 1.4; border: 2px solid #27ae60; font-size: 14px; overflow-x: auto; height: auto; min-height: 0;">
                                                <div style="display: flex; align-items: flex-start;">
                                                    <span style="color: #27ae60; font-weight: bold; margin-right: 0.5rem; display: inline-block; width: 30px; text-align: center; flex-shrink: 0;">✓ {{ correct_label }}</span>
                                                    <div style="text-align: left; flex-grow: 1; white-space: pre;">{{ data.code_blocks.get(correct_label, '') | safe }}</div>
                                                </div>
                                            </div>
                                            {% else %}
                                            <div style="flex: 1; color: #999; font-style: italic;">將程式碼塊拖拉到這裡</div>
                                            {% endif %}
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div style="text-align: center; padding: 3rem; background: #f8f9fa; border-radius: 10px;">
                <h3 style="color: #666; margin-bottom: 1rem;">📝 還沒有題目</h3>
                <p style="color: #888; margin-bottom: 2rem;">開始建立您的第一個題目吧！</p>
                <button onclick="showAddQuestionModal()" class="btn">➕ 新增題目</button>
            </div>
        {% endif %}
    </div>
</div>

<!-- 新增/編輯題目的模態框 -->
<div id="question-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 10px; width: 90%; max-width: 800px; max-height: 90%; overflow-y: auto;">
        <div style="padding: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h2 id="modal-title">新增題目</h2>
                <button onclick="hideQuestionModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">✕</button>
            </div>
            
            <form id="question-form">
                <div class="form-group">
                    <label for="question-title">題目標題 *</label>
                    <input type="text" id="question-title" required>
                </div>
                
                <div class="form-group">
                    <label for="question-text">題目內容 * <span style="color: #667eea; font-size: 0.9rem;">(支援 LaTeX 數學公式)</span></label>
                    <textarea id="question-text" rows="4" required placeholder="例如：計算 $\int_0^1 x^2 dx$ 的值是多少？"></textarea>
                    <p style="color: #666; font-size: 0.85rem; margin-top: 0.5rem;">
                        💡 LaTeX 提示：使用 $...$ 表示行內公式，使用 $$...$$ 表示獨立公式。例如：$x^2 + y^2 = r^2$
                    </p>
                </div>
                
                <div class="form-group">
                    <label for="question-type">題目類型 *</label>
                    <select id="question-type" onchange="handleQuestionTypeChange()" required>
                        <option value="">請選擇題目類型</option>
                        <option value="single_choice">單選題</option>
                        <option value="multiple_choice">多選題</option>
                        <option value="fill_blank">填空題</option>
                        <option value="dropdown">下拉選單</option>
                        <option value="dropdown_fillblank">下拉選單填空題</option>
                        <option value="parsons">程式碼排序題</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="question-points">分數</label>
                    <input type="number" id="question-points" value="1" min="1">
                </div>
                
                <!-- 動態內容區域 -->
                <div id="question-specific-content"></div>
                
                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button type="submit" class="btn" style="flex: 1;">儲存題目</button>
                    <button type="button" onclick="hideQuestionModal()" class="btn btn-secondary" style="flex: 1;">取消</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let currentQuestionId = null;

function showAddQuestionModal() {
    currentQuestionId = null;
    document.getElementById('modal-title').textContent = '新增題目';
    document.getElementById('question-form').reset();
    document.getElementById('question-specific-content').innerHTML = '';
    document.getElementById('question-modal').style.display = 'block';
}

function hideQuestionModal() {
    document.getElementById('question-modal').style.display = 'none';
}

function handleQuestionTypeChange() {
    const type = document.getElementById('question-type').value;
    const container = document.getElementById('question-specific-content');
    
    switch (type) {
        case 'single_choice':
        case 'multiple_choice':
            container.innerHTML = `
                <div class="form-group">
                    <label>選項 * <span style="color: #667eea; font-size: 0.9rem;">(支援 LaTeX 數學公式)</span></label>
                    <div id="options-container">
                        <div class="option-row" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <textarea class="option-input" placeholder="選項內容 (支援多行和LaTeX公式，例如：$\\\\frac{1}{2}$)" style="flex: 1; min-height: 60px;"></textarea>
                            <label style="margin: 0; display: flex; align-items: center;">
                                <input type="${type === 'single_choice' ? 'radio' : 'checkbox'}" name="correct-option" style="margin-right: 0.5rem;">
                                正確
                            </label>
                            <button type="button" onclick="removeOption(this)" class="btn btn-danger" style="padding: 4px 8px;">刪除</button>
                        </div>
                    </div>
                    <button type="button" onclick="addOption()" class="btn btn-secondary" style="margin-top: 0.5rem;">新增選項</button>
                </div>
            `;
            break;
            
        case 'fill_blank':
            container.innerHTML = `
                <div class="form-group">
                    <label for="correct-answer">正確答案 *</label>
                    <input type="text" id="correct-answer" required placeholder="輸入正確答案">
                </div>
            `;
            break;
            
        case 'dropdown':
            container.innerHTML = `
                <div class="form-group">
                    <label>下拉選項 *</label>
                    <div id="dropdown-options-container">
                        <div class="dropdown-option-row" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <textarea class="dropdown-option-input" placeholder="選項內容 (支援多行)" style="flex: 1; min-height: 60px;"></textarea>
                            <label style="margin: 0; display: flex; align-items: center;">
                                <input type="radio" name="correct-dropdown" style="margin-right: 0.5rem;">
                                正確
                            </label>
                            <button type="button" onclick="removeDropdownOption(this)" class="btn btn-danger" style="padding: 4px 8px;">刪除</button>
                        </div>
                    </div>
                    <button type="button" onclick="addDropdownOption()" class="btn btn-secondary" style="margin-top: 0.5rem;">新增選項</button>
                </div>
            `;
            break;
            
        case 'dropdown_fillblank':
            container.innerHTML = `
                <div class="form-group">
                    <label>填空題目文字 *</label>
                    <textarea id="fillblank-text" rows="3" placeholder="請輸入題目文字，使用 {{ '{{}}' }} 標記需要填空的位置。例如：程式設計中，{{ '{{}}' }} 是一種控制結構，用來執行 {{ '{{}}' }} 操作。" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                    <p style="color: #666; font-size: 0.9rem; margin-top: 0.5rem;">使用 {{ '{{}}' }} 標記填空位置，系統會自動為每個 {{ '{{}}' }} 生成對應的下拉選單</p>
                </div>
                
                <div class="form-group">
                    <label>空格選項設定</label>
                    <div id="blanks-container" style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                        <p style="color: #666; margin-bottom: 1rem;">請先在上方文字中使用 {{ '{{}}' }} 標記填空位置，然後點擊下方按鈕解析空格</p>
                        <button type="button" onclick="parseBlanks()" class="btn btn-primary" style="margin-bottom: 1rem;">解析空格</button>
                        <div id="blanks-options-container"></div>
                    </div>
                </div>
            `;
            break;
            
        case 'parsons':
            container.innerHTML = `
                <div class="form-group">
                    <label>可供選擇的程式碼塊 *</label>
                    <div id="code-blocks-container" style="background: #e8f5e8; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <div class="code-block-row" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem; align-items: center;">
                            <span style="min-width: 30px; color: #666;">A</span>
                            <textarea class="code-block-input" placeholder="程式碼塊內容 (支援多行)" style="flex: 1; min-height: 60px; font-family: monospace;"></textarea>
                            <button type="button" onclick="removeCodeBlock(this)" class="btn btn-danger" style="padding: 4px 8px;">刪除</button>
                        </div>
                    </div>
                    <button type="button" onclick="addCodeBlock()" class="btn btn-success" style="margin-bottom: 1.5rem;">新增程式碼塊</button>
                    
                    <label>答案區空格設定 *</label>
                    <div style="background: #f0f7ff; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <div style="display: flex; gap: 1rem; align-items: center; margin-bottom: 1rem;">
                            <label style="margin: 0;">答案區空格數量：</label>
                            <input type="number" id="answer-slots-count" min="1" value="3" style="width: 80px;" onchange="updateAnswerSlots()">
                            <button type="button" onclick="updateAnswerSlots()" class="btn btn-secondary" style="padding: 6px 12px;">更新空格</button>
                        </div>
                        <div id="answer-slots-container"></div>
                    </div>
                    
                    <p style="color: #666; font-size: 0.9rem; margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                        <strong>📝 說明：</strong><br>
                        • 先設定所有可供選擇的程式碼塊（標記為A、B、C...）<br>
                        • 設定答案區有多少個空格<br>
                        • 為每個空格選擇正確的程式碼塊<br>
                        • 學生需要從程式碼塊中選擇並按順序拖拉到答案區對應的空格
                    </p>
                </div>
            `;
            break;
            
        default:
            container.innerHTML = '';
    }
}

function addOption() {
    const container = document.getElementById('options-container');
    const isMultiple = document.getElementById('question-type').value === 'multiple_choice';
    const optionRow = document.createElement('div');
    optionRow.className = 'option-row';
    optionRow.style.cssText = 'display: flex; gap: 0.5rem; margin-bottom: 0.5rem;';
    optionRow.innerHTML = `
        <textarea class="option-input" placeholder="選項內容 (支援多行和LaTeX公式，例如：$\\\\frac{1}{2}$)" style="flex: 1; min-height: 60px;"></textarea>
        <label style="margin: 0; display: flex; align-items: center;">
            <input type="${isMultiple ? 'checkbox' : 'radio'}" name="correct-option" style="margin-right: 0.5rem;">
            正確
        </label>
        <button type="button" onclick="removeOption(this)" class="btn btn-danger" style="padding: 4px 8px;">刪除</button>
    `;
    container.appendChild(optionRow);
}

function removeOption(button) {
    button.parentNode.remove();
}

function addDropdownOption() {
    const container = document.getElementById('dropdown-options-container');
    const optionRow = document.createElement('div');
    optionRow.className = 'dropdown-option-row';
    optionRow.style.cssText = 'display: flex; gap: 0.5rem; margin-bottom: 0.5rem;';
    optionRow.innerHTML = `
        <textarea class="dropdown-option-input" placeholder="選項內容 (支援多行)" style="flex: 1; min-height: 60px;"></textarea>
        <label style="margin: 0; display: flex; align-items: center;">
            <input type="radio" name="correct-dropdown" style="margin-right: 0.5rem;">
            正確
        </label>
        <button type="button" onclick="removeDropdownOption(this)" class="btn btn-danger" style="padding: 4px 8px;">刪除</button>
    `;
    container.appendChild(optionRow);
}

function removeDropdownOption(button) {
    button.parentNode.remove();
}

function addCodeBlock() {
    const container = document.getElementById('code-blocks-container');
    const blockCount = container.children.length;
    const blockLabel = String.fromCharCode(65 + blockCount); // A, B, C...
    const blockRow = document.createElement('div');
    blockRow.className = 'code-block-row';
    blockRow.style.cssText = 'display: flex; gap: 0.5rem; margin-bottom: 0.5rem; align-items: center;';
    blockRow.innerHTML = `
        <span style="min-width: 30px; color: #667eea; font-weight: bold;">${blockLabel}</span>
        <textarea class="code-block-input" placeholder="程式碼塊內容 (支援多行)" style="flex: 1; min-height: 60px; font-family: monospace;"></textarea>
        <button type="button" onclick="removeCodeBlock(this)" class="btn btn-danger" style="padding: 4px 8px;">刪除</button>
    `;
    container.appendChild(blockRow);
    updateAnswerSlots();
}

function removeCodeBlock(button) {
    button.parentNode.remove();
    // 重新編號
    const container = document.getElementById('code-blocks-container');
    Array.from(container.children).forEach((row, index) => {
        const labelSpan = row.querySelector('span');
        if (labelSpan) labelSpan.textContent = String.fromCharCode(65 + index);
    });
    updateAnswerSlots();
}

function updateAnswerSlots() {
    const slotsCount = parseInt(document.getElementById('answer-slots-count').value) || 1;
    const container = document.getElementById('answer-slots-container');
    
    // 獲取所有可用的程式碼塊
    const codeBlockInputs = document.querySelectorAll('.code-block-input');
    const codeBlocks = Array.from(codeBlockInputs).map((input, index) => {
        return {
            label: String.fromCharCode(65 + index),
            preview: input.value.substring(0, 30) + (input.value.length > 30 ? '...' : '')
        };
    });
    
    if (codeBlocks.length === 0) {
        container.innerHTML = '<p style="color: #e74c3c; margin: 0;">請先添加程式碼塊</p>';
        return;
    }
    
    // 保存現有的選擇
    const currentSelections = {};
    container.querySelectorAll('.slot-answer-select').forEach((select, index) => {
        currentSelections[index + 1] = select.value;
    });
    
    container.innerHTML = '';
    
    for (let i = 1; i <= slotsCount; i++) {
        const slotDiv = document.createElement('div');
        slotDiv.style.cssText = 'display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.8rem; padding: 0.8rem; background: white; border-radius: 6px; border: 1px solid #ddd;';
        
        let selectHTML = `
            <label style="min-width: 80px; margin: 0; font-weight: bold; color: #333;">空格 ${i}：</label>
            <select class="slot-answer-select" data-slot="${i}" style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-family: monospace;">
                <option value="">請選擇正確答案...</option>
        `;
        
        codeBlocks.forEach(block => {
            const selected = currentSelections[i] === block.label ? 'selected' : '';
            selectHTML += `<option value="${block.label}" ${selected}>${block.label} - ${block.preview || '(空白)'}</option>`;
        });
        
        selectHTML += '</select>';
        slotDiv.innerHTML = selectHTML;
        container.appendChild(slotDiv);
    }
}

// 下拉選單填空題型函數
function parseBlanks() {
    const fillblankText = document.getElementById('fillblank-text').value;
    const container = document.getElementById('blanks-options-container');
    
    // 找出所有 {{ '{{}}' }} 標記
    const blanks = fillblankText.match(/\{\{[^}]*\}\}/g) || [];
    
    if (blanks.length === 0) {
        alert('請先在題目文字中使用 {{ '{{}}' }} 標記填空位置');
        return;
    }
    
    container.innerHTML = '';
    
    blanks.forEach((blank, index) => {
        const blankDiv = document.createElement('div');
        blankDiv.style.cssText = 'border: 1px solid #ddd; border-radius: 6px; padding: 1rem; margin-bottom: 1rem; background: white;';
        
        blankDiv.innerHTML = `
            <h4 style="margin: 0 0 1rem 0; color: #333;">空格 ${index + 1}: ${blank}</h4>
            <div class="blank-options" data-blank-index="${index}">
                <div class="blank-option-row" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem; align-items: center;">
                    <textarea class="blank-option-input" placeholder="選項內容 (支援多行)" style="flex: 1; min-height: 60px;"></textarea>
                    <label style="margin: 0; display: flex; align-items: center;">
                        <input type="radio" name="correct-blank-${index}" style="margin-right: 0.5rem;">
                        正確答案
                    </label>
                    <button type="button" onclick="removeBlankOption(this)" class="btn btn-danger" style="padding: 4px 8px;">刪除</button>
                </div>
            </div>
            <button type="button" onclick="addBlankOption(${index})" class="btn btn-secondary" style="margin-top: 0.5rem;">新增選項</button>
        `;
        
        container.appendChild(blankDiv);
    });
}

function addBlankOption(blankIndex) {
    const container = document.querySelector(`[data-blank-index="${blankIndex}"]`);
    const optionRow = document.createElement('div');
    optionRow.className = 'blank-option-row';
    optionRow.style.cssText = 'display: flex; gap: 0.5rem; margin-bottom: 0.5rem; align-items: center;';
    optionRow.innerHTML = `
        <textarea class="blank-option-input" placeholder="選項內容 (支援多行)" style="flex: 1; min-height: 60px;"></textarea>
        <label style="margin: 0; display: flex; align-items: center;">
            <input type="radio" name="correct-blank-${blankIndex}" style="margin-right: 0.5rem;">
            正確答案
        </label>
        <button type="button" onclick="removeBlankOption(this)" class="btn btn-danger" style="padding: 4px 8px;">刪除</button>
    `;
    container.appendChild(optionRow);
}

function removeBlankOption(button) {
    button.parentNode.remove();
}

// 表單提交
document.getElementById('question-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = collectFormData();
    if (!validateFormData(formData)) return;
    
    try {
        const url = currentQuestionId ? 
            `/api/question/${currentQuestionId}` : 
            `/api/quiz-bank/{{ quiz_bank.id }}/questions`;
        const method = currentQuestionId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            alert(result.message);
            hideQuestionModal();
            location.reload();
        } else {
            alert(result.error || '操作失敗');
        }
    } catch (error) {
        alert('網路錯誤，請稍後再試');
    }
});

function collectFormData() {
    const title = document.getElementById('question-title').value;
    const text = document.getElementById('question-text').value;
    const type = document.getElementById('question-type').value;
    const points = parseInt(document.getElementById('question-points').value);
    
    const questionData = {};
    
    switch (type) {
        case 'single_choice':
        case 'multiple_choice':
            const optionInputs = document.querySelectorAll('.option-input');
            const correctInputs = document.querySelectorAll('input[name="correct-option"]:checked');
            
            questionData.options = Array.from(optionInputs).map(input => input.value);
            
            if (type === 'single_choice') {
                const correctIndex = Array.from(document.querySelectorAll('input[name="correct-option"]')).findIndex(input => input.checked);
                questionData.correct_answer = correctIndex >= 0 ? questionData.options[correctIndex] : '';
            } else {
                const correctIndices = Array.from(correctInputs).map(input => {
                    return Array.from(document.querySelectorAll('input[name="correct-option"]')).indexOf(input);
                });
                questionData.correct_answers = correctIndices.map(index => questionData.options[index]);
            }
            break;
            
        case 'fill_blank':
            questionData.correct_answer = document.getElementById('correct-answer').value;
            break;
            
        case 'dropdown':
            const dropdownInputs = document.querySelectorAll('.dropdown-option-input');
            const correctDropdown = document.querySelector('input[name="correct-dropdown"]:checked');
            
            questionData.options = Array.from(dropdownInputs).map(input => input.value);
            
            if (correctDropdown) {
                const correctIndex = Array.from(document.querySelectorAll('input[name="correct-dropdown"]')).indexOf(correctDropdown);
                questionData.correct_answer = questionData.options[correctIndex];
            }
            break;
            
        case 'dropdown_fillblank':
            const fillblankText = document.getElementById('fillblank-text').value;
            questionData.fillblank_text = fillblankText;
            
            // 收集每個空格的選項和正確答案
            const blanksData = [];
            const blankContainers = document.querySelectorAll('[data-blank-index]');
            
            blankContainers.forEach((container, index) => {
                const blankIndex = container.getAttribute('data-blank-index');
                const optionInputs = container.querySelectorAll('.blank-option-input');
                const correctInput = container.querySelector(`input[name="correct-blank-${blankIndex}"]:checked`);
                
                const options = Array.from(optionInputs).map(input => input.value.trim()).filter(v => v);
                let correctAnswer = '';
                
                if (correctInput) {
                    const correctIndex = Array.from(container.querySelectorAll(`input[name="correct-blank-${blankIndex}"]`)).indexOf(correctInput);
                    correctAnswer = options[correctIndex] || '';
                }
                
                blanksData.push({
                    options: options,
                    correct_answer: correctAnswer
                });
            });
            
            questionData.blanks = blanksData;
            break;
            
        case 'parsons':
            const codeBlockInputs = document.querySelectorAll('.code-block-input');
            const slotSelects = document.querySelectorAll('.slot-answer-select');
            
            // 收集所有程式碼塊，使用標籤(A, B, C...)作為key
            const codeBlocks = {};
            Array.from(codeBlockInputs).forEach((input, index) => {
                const label = String.fromCharCode(65 + index);
                const content = input.value.trim();
                if (content) {
                    codeBlocks[label] = content;
                }
            });
            
            // 收集答案區空格的正確答案
            const slotAnswers = {};
            Array.from(slotSelects).forEach((select) => {
                const slotNumber = select.dataset.slot;
                const answer = select.value;
                if (answer) {
                    slotAnswers[slotNumber] = answer;
                }
            });
            
            questionData.code_blocks = codeBlocks; // {A: "code1", B: "code2", C: "code3"}
            questionData.answer_slots = slotSelects.length; // 答案區空格數量
            questionData.slot_answers = slotAnswers; // {1: "A", 2: "C", 3: "B"}
            break;
    }
    
    return {
        title,
        question_text: text,
        question_type: type,
        points,
        question_data: questionData
    };
}

function validateFormData(data) {
    if (!data.title || !data.question_text || !data.question_type) {
        alert('請填寫所有必填欄位');
        return false;
    }
    
    switch (data.question_type) {
        case 'single_choice':
        case 'multiple_choice':
            if (!data.question_data.options || data.question_data.options.length < 2) {
                alert('至少需要2個選項');
                return false;
            }
            if (data.question_type === 'single_choice' && !data.question_data.correct_answer) {
                alert('請選擇正確答案');
                return false;
            }
            if (data.question_type === 'multiple_choice' && (!data.question_data.correct_answers || data.question_data.correct_answers.length === 0)) {
                alert('請選擇至少一個正確答案');
                return false;
            }
            break;
            
        case 'fill_blank':
            if (!data.question_data.correct_answer) {
                alert('請輸入正確答案');
                return false;
            }
            break;
            
        case 'dropdown':
            if (!data.question_data.options || data.question_data.options.length < 2) {
                alert('至少需要2個選項');
                return false;
            }
            if (!data.question_data.correct_answer) {
                alert('請選擇正確答案');
                return false;
            }
            break;
            
        case 'dropdown_fillblank':
            if (!data.question_data.fillblank_text) {
                alert('請輸入填空題目文字');
                return false;
            }
            if (!data.question_data.blanks || data.question_data.blanks.length === 0) {
                alert('請先解析空格並設定選項');
                return false;
            }
            
            // 檢查每個空格是否都有選項和正確答案
            for (let i = 0; i < data.question_data.blanks.length; i++) {
                const blank = data.question_data.blanks[i];
                if (!blank.options || blank.options.length < 2) {
                    alert(`空格 ${i + 1} 至少需要2個選項`);
                    return false;
                }
                if (!blank.correct_answer) {
                    alert(`空格 ${i + 1} 請選擇正確答案`);
                    return false;
                }
            }
            break;
            
        case 'parsons':
            if (!data.question_data.code_blocks || Object.keys(data.question_data.code_blocks).length < 2) {
                alert('至少需要2個程式碼塊');
                return false;
            }
            if (!data.question_data.slot_answers || Object.keys(data.question_data.slot_answers).length === 0) {
                alert('請為每個空格設定正確答案');
                return false;
            }
            // 檢查是否所有空格都有答案
            const totalSlots = data.question_data.answer_slots;
            const answeredSlots = Object.keys(data.question_data.slot_answers).length;
            if (answeredSlots < totalSlots) {
                alert(`請為所有 ${totalSlots} 個空格設定正確答案（目前只設定了 ${answeredSlots} 個）`);
                return false;
            }
            break;
    }
    
    return true;
}

async function editQuestion(questionId) {
    currentQuestionId = questionId;
    document.getElementById('modal-title').textContent = '編輯題目';
    
    try {
        // 從API獲取題目數據
        const response = await fetch(`/api/quiz-bank/{{ quiz_bank.id }}/questions`);
        const questions = await response.json();
        
        // 找到要編輯的題目
        const question = questions.find(q => q.id === questionId);
        if (!question) {
            alert('找不到題目數據');
            return;
        }
        
        // 填充基本信息
        document.getElementById('question-title').value = question.title;
        document.getElementById('question-text').value = question.question_text;
        document.getElementById('question-type').value = question.question_type;
        document.getElementById('question-points').value = question.points;
        
        // 觸發類型變更事件以生成對應的表單
        handleQuestionTypeChange();
        
        // 根據題目類型填充特定內容
        if (question.question_data) {
            const data = question.question_data;
            
            switch (question.question_type) {
                case 'single_choice':
                case 'multiple_choice':
                    // 清空現有選項
                    document.getElementById('options-container').innerHTML = '';
                    
                    // 添加選項
                    if (data.options && data.options.length > 0) {
                        data.options.forEach(option => {
                            const optionRow = document.createElement('div');
                            optionRow.className = 'option-row';
                            optionRow.style.cssText = 'display: flex; gap: 0.5rem; margin-bottom: 0.5rem;';
                            
                            const isCorrect = question.question_type === 'single_choice' 
                                ? option === data.correct_answer
                                : (data.correct_answers && data.correct_answers.includes(option));
                            
                            optionRow.innerHTML = `
                                <textarea class="option-input" placeholder="選項內容 (支援多行)" style="flex: 1; min-height: 60px;">${option}</textarea>
                                <label style="margin: 0; display: flex; align-items: center;">
                                    <input type="${question.question_type === 'single_choice' ? 'radio' : 'checkbox'}" 
                                           name="correct-option" style="margin-right: 0.5rem;" ${isCorrect ? 'checked' : ''}>
                                    正確
                                </label>
                                <button type="button" onclick="removeOption(this)" class="btn btn-danger" style="padding: 4px 8px;">刪除</button>
                            `;
                            
                            document.getElementById('options-container').appendChild(optionRow);
                        });
                    }
                    break;
                    
                case 'fill_blank':
                    if (data.correct_answer) {
                        document.getElementById('correct-answer').value = data.correct_answer;
                    }
                    break;
                    
                case 'dropdown':
                    // 清空現有選項
                    document.getElementById('dropdown-options-container').innerHTML = '';
                    
                    // 添加選項
                    if (data.options && data.options.length > 0) {
                        data.options.forEach(option => {
                            const optionRow = document.createElement('div');
                            optionRow.className = 'dropdown-option-row';
                            optionRow.style.cssText = 'display: flex; gap: 0.5rem; margin-bottom: 0.5rem;';
                            
                            const isCorrect = option === data.correct_answer;
                            
                            optionRow.innerHTML = `
                                <textarea class="dropdown-option-input" placeholder="選項內容 (支援多行)" style="flex: 1; min-height: 60px;">${option}</textarea>
                                <label style="margin: 0; display: flex; align-items: center;">
                                    <input type="radio" name="correct-dropdown" style="margin-right: 0.5rem;" ${isCorrect ? 'checked' : ''}>
                                    正確
                                </label>
                                <button type="button" onclick="removeDropdownOption(this)" class="btn btn-danger" style="padding: 4px 8px;">刪除</button>
                            `;
                            
                            document.getElementById('dropdown-options-container').appendChild(optionRow);
                        });
                    }
                    break;
                    
                case 'dropdown_fillblank':
                    // 填充題目文字
                    if (data.fillblank_text) {
                        document.getElementById('fillblank-text').value = data.fillblank_text;
                    }
                    
                    // 解析空格
                    parseBlanks();
                    
                    // 填充空格選項
                    if (data.blanks && data.blanks.length > 0) {
                        setTimeout(() => {
                            data.blanks.forEach((blank, index) => {
                                const blankContainer = document.querySelector(`[data-blank-index="${index}"]`);
                                if (!blankContainer) return;
                                
                                // 清空現有選項
                                blankContainer.innerHTML = '';
                                
                                // 添加選項
                                if (blank.options && blank.options.length > 0) {
                                    blank.options.forEach(option => {
                                        const optionRow = document.createElement('div');
                                        optionRow.className = 'blank-option-row';
                                        optionRow.style.cssText = 'display: flex; gap: 0.5rem; margin-bottom: 0.5rem; align-items: center;';
                                        
                                        const isCorrect = option === blank.correct_answer;
                                        
                                        optionRow.innerHTML = `
                                            <textarea class="blank-option-input" placeholder="選項內容 (支援多行)" style="flex: 1; min-height: 60px;">${option}</textarea>
                                            <label style="margin: 0; display: flex; align-items: center;">
                                                <input type="radio" name="correct-blank-${index}" style="margin-right: 0.5rem;" ${isCorrect ? 'checked' : ''}>
                                                正確答案
                                            </label>
                                            <button type="button" onclick="removeBlankOption(this)" class="btn btn-danger" style="padding: 4px 8px;">刪除</button>
                                        `;
                                        
                                        blankContainer.appendChild(optionRow);
                                    });
                                }
                            });
                        }, 100); // 延遲一下以確保空格容器已經生成
                    }
                    break;
                    
                case 'parsons':
                    // 清空現有程式碼塊
                    const codeBlocksContainer = document.getElementById('code-blocks-container');
                    codeBlocksContainer.innerHTML = '';
                    
                    let codeBlocks = data.code_blocks || {};
                    let answerSlots = data.answer_slots || Object.keys(data.code_blocks).length;
                    let slotAnswers = data.slot_answers || {};
                    
                    // 添加程式碼塊
                    const labels = Object.keys(codeBlocks).sort();
                    labels.forEach((label, index) => {
                        const blockRow = document.createElement('div');
                        blockRow.className = 'code-block-row';
                        blockRow.style.cssText = 'display: flex; gap: 0.5rem; margin-bottom: 0.5rem; align-items: center;';
                        blockRow.innerHTML = `
                            <span style="min-width: 30px; color: #667eea; font-weight: bold;">${label}</span>
                            <textarea class="code-block-input" placeholder="程式碼塊內容 (支援多行)" style="flex: 1; min-height: 60px; font-family: monospace;">${codeBlocks[label]}</textarea>
                            <button type="button" onclick="removeCodeBlock(this)" class="btn btn-danger" style="padding: 4px 8px;">刪除</button>
                        `;
                        codeBlocksContainer.appendChild(blockRow);
                    });
                    
                    // 設定答案區空格數量
                    document.getElementById('answer-slots-count').value = answerSlots;
                    
                    // 更新答案區空格（會自動使用slotAnswers填充）
                    setTimeout(() => {
                        updateAnswerSlots();
                        
                        // 設定每個空格的答案
                        Object.keys(slotAnswers).forEach(slotNum => {
                            const select = document.querySelector(`.slot-answer-select[data-slot="${slotNum}"]`);
                            if (select) {
                                select.value = slotAnswers[slotNum];
                            }
                        });
                    }, 100);
                    
                    break;
            }
        }
        
        // 顯示模態框
        document.getElementById('question-modal').style.display = 'block';
        
    } catch (error) {
        console.error('獲取題目數據失敗', error);
        alert('獲取題目數據失敗，請稍後再試');
    }
}

async function deleteQuestion(questionId) {
    if (!confirm('確定要刪除這個題目嗎？')) return;
    
    try {
        const response = await fetch(`/api/question/${questionId}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (response.ok) {
            alert(result.message);
            location.reload();
        } else {
            alert(result.error || '刪除失敗');
        }
    } catch (error) {
        alert('網路錯誤，請稍後再試');
    }
}

// 重新渲染 MathJax，當頁面載入時
document.addEventListener('DOMContentLoaded', function() {
    if (typeof MathJax !== 'undefined') {
        MathJax.typesetPromise().catch((err) => console.log('MathJax typeset error:', err));
    }
});

</script>

{% endblock %}
