{% extends "quiz_base.html" %}

{% block title %}{{ quiz_bank.title }} - æ¸¬é©—ç­”é¡Œ{% endblock %}

{% block content %}
<div>
    <div class="card" style="margin-bottom: 2rem;">
        <div class="card-header">
            <h1 style="margin: 0;">ğŸ“ {{ quiz_bank.title }}</h1>
        </div>
        <div class="card-body">
            {% if quiz_bank.description %}
            <p>{{ quiz_bank.description }}</p>
            {% endif %}
            
            <!-- å­¸ç”Ÿè³‡æ–™å¡«å¯« -->
            <div id="student-info-section" style="margin-bottom: 2rem;">
                <h3 style="margin-bottom: 1rem;">è«‹å…ˆå¡«å¯«æ‚¨çš„è³‡æ–™</h3>
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label for="student-name">å§“å *</label>
                        <input type="text" id="student-name" required placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å">
                    </div>
                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label for="student-email">é›»å­éƒµä»¶ï¼ˆå¯é¸ï¼‰</label>
                        <input type="email" id="student-email" placeholder="æ‚¨çš„é›»å­éƒµä»¶">
                    </div>
                </div>
                <button onclick="startQuiz()" class="btn">é–‹å§‹æ¸¬é©—</button>
            </div>
            
            <!-- æ¸¬é©—é€²åº¦ -->
            <div id="quiz-progress" style="display: none; margin-bottom: 1rem;">
                <div style="background: #f8f9fa; border-radius: 8px; padding: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>é€²åº¦ï¼š<span id="current-question">1</span> / {{ questions|length }}</span>
                        <span>ç¸½åˆ†ï¼š{{ questions|sum(attribute='points') }} åˆ†</span>
                    </div>
                    <div style="background: #e9ecef; border-radius: 4px; height: 8px; margin-top: 0.5rem;">
                        <div id="progress-bar" style="background: #667eea; height: 100%; border-radius: 4px; width: 0%; transition: width 0.3s;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æ¸¬é©—é¡Œç›® -->
    <div id="quiz-questions" style="display: none;">
        {% for question in questions %}
        <div class="question-card" data-question-id="{{ question.id }}" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h3>é¡Œç›® {{ loop.index }}ï¼š{{ question.title }}</h3>
                        <span class="question-type-badge">{{ get_question_type_name(question.question_type) }} - {{ question.points }}åˆ†</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="question-text" style="margin-bottom: 1.5rem; font-size: 1.1rem; line-height: 1.6; white-space: pre-wrap; font-family: Consolas, monospace;">{{ question.question_text | trim }}</div>
                    
                    <!-- å–®é¸é¡Œ -->
                    {% if question.question_type == 'single_choice' %}
                    <div class="options-container">
                        {% for option in question.options %}
                        <div class="option" data-option-value="{{ option|e }}" onclick="selectSingleOption(this, '{{ question.id }}')">
                            <input type="radio" name="question-{{ question.id }}" value="{{ option }}">
                            <div class="option-text">{{ option }}</div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- å¤šé¸é¡Œ -->
                    {% elif question.question_type == 'multiple_choice' %}
                    <div class="options-container">
                        {% for option in question.options %}
                        <div class="option" data-option-value="{{ option|e }}" onclick="toggleMultipleOption(this, '{{ question.id }}')">
                            <input type="checkbox" name="question-{{ question.id }}" value="{{ option }}">
                            <div class="option-text">{{ option }}</div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- å¡«ç©ºé¡Œ -->
                    {% elif question.question_type == 'fill_blank' %}
                    <div class="form-group">
                        <input type="text" id="answer-{{ question.id }}" placeholder="è«‹è¼¸å…¥ç­”æ¡ˆ" style="font-size: 1.1rem;">
                    </div>
                    
                    <!-- ä¸‹æ‹‰é¸å–® -->
                    {% elif question.question_type == 'dropdown' %}
                    <div class="form-group">
                        <select id="answer-{{ question.id }}" style="font-size: 1.1rem;">
                            <option value="">è«‹é¸æ“‡ç­”æ¡ˆ</option>
                            {% for option in question.options %}
                            <option value="{{ option }}">{{ option }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- ä¸‹æ‹‰é¸å–®å¡«ç©ºé¡Œ -->
                    {% elif question.question_type == 'dropdown_fillblank' %}
                    <div class="dropdown-fillblank-container" data-question-id="{{ question.id }}">
                        <div class="fillblank-text" style="font-size: 1.1rem; line-height: 1.6; margin-bottom: 1rem;">
                            {{ question.fillblank_text | safe }}
                        </div>
                    </div>
                    
                    <!-- ç¨‹å¼ç¢¼æ’åºé¡Œ -->
                    {% elif question.question_type == 'parsons' %}
                    <div class="parsons-container">
                        <div class="parsons-bank">
                            <h4 style="text-align: center; margin-bottom: 1rem; color: #666;">ç¨‹å¼ç¢¼å¡Š</h4>
                            <div id="code-bank-{{ question.id }}">
                                {% for label in question.code_blocks.keys() | sort %}
                                <div class="code-block" draggable="true" data-block="{{ question.code_blocks[label] }}" data-label="{{ label }}">
                                    <div style="white-space: pre-wrap;">{{ question.code_blocks[label] | safe }}</div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="parsons-target">
                            <h4 style="text-align: center; margin-bottom: 1rem; color: #667eea;">ç­”é¡Œå€ (è«‹æŒ‰æ­£ç¢ºé †åºæ’åˆ—)</h4>
                            <div id="code-target-{{ question.id }}" class="drop-zone">
                                <!-- æ ¹æ“šè¨­å®šçš„answer_slotsç”¢ç”Ÿç©ºç™½å€å¡Š -->
                                {% set slots_count = question.answer_slots %}
                                {% for i in range(slots_count) %}
                                {% set is_fixed = question.fixed_blocks and ((i + 1)|string in question.fixed_blocks) %}
                                <div class="answer-slot" data-slot="{{ i + 1 }}" {% if is_fixed %}data-fixed="true"{% endif %}>
                                    {% if is_fixed %}
                                    <!-- å›ºå®šç¨‹å¼ç¢¼å¡Šï¼ˆåªè®€é¡¯ç¤ºï¼Œæ¨£å¼è·Ÿå·¦å´ç¨‹å¼ç¢¼å¡Šä¸€è‡´ï¼‰ -->
                                    {% set fixed = question.fixed_blocks[(i + 1)|string] %}
                                    <div class="fixed-code-block" style="flex: 1; width: 100%; padding: 0.4rem 1rem; font-family: Consolas, monospace; background: #2d3748; color: #e2e8f0; border-radius: 6px; white-space: pre-wrap; line-height: 1.4; pointer-events: none; user-select: none; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">{{ fixed.content }}</div>
                                    <div class="fixed-label" style="position: absolute; top: 8px; right: 8px; background: #667eea; color: white; padding: 3px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; z-index: 10;">å›ºå®š</div>
                                    {% else %}
                                    <!-- æ™®é€šå¯æ‹–æ‹‰å€å¡Šï¼ˆä¸é¡¯ç¤ºç·¨è™Ÿï¼‰ -->
                                    <div class="slot-content">å°‡ç¨‹å¼ç¢¼å¡Šæ‹–æ‹‰åˆ°é€™è£¡</div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div class="card-footer">
                    <div style="display: flex; justify-content: space-between;">
                        <button onclick="previousQuestion()" class="btn btn-secondary" {% if loop.first %}disabled{% endif %}>
                            â† ä¸Šä¸€é¡Œ
                        </button>
                        {% if loop.last %}
                        <button onclick="submitQuiz()" class="btn btn-success">æäº¤æ¸¬é©—</button>
                        {% else %}
                        <button onclick="nextQuestion()" class="btn">ä¸‹ä¸€é¡Œ â†’</button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <!-- å®Œæˆè¨Šæ¯ -->
    <div id="completion-message" style="display: none; text-align: center; padding: 3rem;">
        <h2 style="color: #27ae60; margin-bottom: 1rem;">ğŸ‰ æ¸¬é©—å®Œæˆï¼</h2>
        <div id="score-display" style="background: #f8f9fa; padding: 2rem; border-radius: 10px; margin: 2rem auto; max-width: 400px;">
            <div style="font-size: 3rem; color: #667eea; margin-bottom: 1rem;" id="score-percentage">--</div>
            <div style="font-size: 1.2rem; color: #333;" id="score-details">è¨ˆç®—ä¸­...</div>
        </div>
        <!-- ç§»é™¤è¿”å›é¦–é æŒ‰éˆ• -->
    </div>
</div>

<script>
let currentQuestionIndex = 0;
let totalQuestions = {{ questions|length }};
let studentAnswers = {};
let quizStarted = false;

// ç¢ºä¿ studentAnswers åœ¨å…¨åŸŸç¯„åœå…§å¯å­˜å–
window.studentAnswers = studentAnswers;

console.log('=== Quiz initialization ===');
console.log('Total questions:', totalQuestions);
console.log('Initial studentAnswers:', studentAnswers);

// å„²å­˜é¡Œç›®è³‡æ–™ä¾› JavaScript ä½¿ç”¨
window.questionsData = {{ questions | tojson | safe }};

function startQuiz() {
    const studentName = document.getElementById('student-name').value.trim();
    if (!studentName) {
        alert('è«‹è¼¸å…¥æ‚¨çš„å§“å');
        return;
    }
    
    quizStarted = true;
    document.getElementById('student-info-section').style.display = 'none';
    document.getElementById('quiz-progress').style.display = 'block';
    document.getElementById('quiz-questions').style.display = 'block';
    
    showQuestion(0);
}

function showQuestion(index) {
    // éš±è—æ‰€æœ‰é¡Œç›®
    const questions = document.querySelectorAll('.question-card');
    questions.forEach(q => q.style.display = 'none');
    
    // é¡¯ç¤ºç•¶å‰é¡Œç›®
    if (questions[index]) {
        questions[index].style.display = 'block';
        currentQuestionIndex = index;
        
        // æ›´æ–°é€²åº¦
        document.getElementById('current-question').textContent = index + 1;
        const progress = ((index + 1) / totalQuestions) * 100;
        document.getElementById('progress-bar').style.width = progress + '%';
        
        // åˆå§‹åŒ– Parsons Puzzle
        initializeParsons(questions[index]);
        
        // åˆå§‹åŒ–ä¸‹æ‹‰é¸å–®å¡«ç©ºé¡Œ
        initializeDropdownFillblank(questions[index]);
        
        // é‡æ–°æ¸²æŸ“ MathJax
        if (typeof MathJax !== 'undefined') {
            MathJax.typesetPromise([questions[index]]).catch((err) => console.log('MathJax typeset error:', err));
        }
    }
}

function nextQuestion() {
    if (currentQuestionIndex < totalQuestions - 1) {
        showQuestion(currentQuestionIndex + 1);
    }
}

function previousQuestion() {
    if (currentQuestionIndex > 0) {
        showQuestion(currentQuestionIndex - 1);
    }
}

function selectSingleOption(element, questionId) {
    // å¾ data å±¬æ€§è®€å–é¸é …å€¼
    const value = element.getAttribute('data-option-value');
    
    // æ¸…é™¤åŒçµ„å…¶ä»–é¸é …çš„é¸ä¸­ç‹€æ…‹
    const container = element.parentNode;
    container.querySelectorAll('.option').forEach(opt => {
        opt.classList.remove('selected');
        opt.querySelector('input').checked = false;
    });
    
    // è¨­å®šç•¶å‰é¸é …ç‚ºé¸ä¸­
    element.classList.add('selected');
    element.querySelector('input').checked = true;
    
    // å„²å­˜ç­”æ¡ˆ - èª¿è©¦ä¿¡æ¯
    console.log(`Selected option for question ${questionId}:`, value);
    console.log(`Value type: ${typeof value}, length: ${value ? value.length : 0}`);
    console.log(`Value JSON:`, JSON.stringify(value));
    console.log(`Value bytes:`, Array.from(new TextEncoder().encode(value || '')));
    
    // å¤šè¡Œæª¢æŸ¥
    if (value && value.includes('\n')) {
        console.log(`Multi-line option detected:`);
        const lines = value.split('\n');
        lines.forEach((line, i) => {
            console.log(`  Line ${i}: ${JSON.stringify(line)}`);
        });
    }
    
    // ç¢ºä¿ studentAnswers å°è±¡å­˜åœ¨
    if (typeof studentAnswers === 'undefined') {
        console.error('studentAnswers object is undefined!');
        window.studentAnswers = {};
    }
    
    studentAnswers[questionId] = value;
    console.log(`Stored answer for question ${questionId}:`, studentAnswers[questionId]);
    console.log(`Current studentAnswers:`, studentAnswers);
}

function toggleMultipleOption(element, questionId) {
    // å¾ data å±¬æ€§è®€å–é¸é …å€¼
    const value = element.getAttribute('data-option-value');
    const checkbox = element.querySelector('input');
    const isChecked = !checkbox.checked;
    
    checkbox.checked = isChecked;
    element.classList.toggle('selected', isChecked);
    
    // ç¢ºä¿ studentAnswers å°è±¡å­˜åœ¨
    if (typeof studentAnswers === 'undefined') {
        console.error('studentAnswers object is undefined!');
        window.studentAnswers = {};
    }
    
    // å„²å­˜ç­”æ¡ˆ
    if (!studentAnswers[questionId]) {
        studentAnswers[questionId] = [];
    }
    
    if (isChecked) {
        if (!studentAnswers[questionId].includes(value)) {
            studentAnswers[questionId].push(value);
        }
    } else {
        studentAnswers[questionId] = studentAnswers[questionId].filter(v => v !== value);
    }
    
    console.log(`Multiple choice answer for question ${questionId}:`, studentAnswers[questionId]);
}

// Parsons Puzzle æ‹–æ‹‰åŠŸèƒ½
function initializeParsons(questionElement) {
    const parsonsContainer = questionElement.querySelector('.parsons-container');
    if (!parsonsContainer) return;
    
    const questionId = questionElement.dataset.questionId;
    const codeBlocks = parsonsContainer.querySelectorAll('.code-block');
    const answerSlots = parsonsContainer.querySelectorAll('.answer-slot');
    
    // åˆå§‹åŒ–ç¨‹å¼ç¢¼å¡Šçš„æ‹–æ‹‰åŠŸèƒ½
    codeBlocks.forEach(block => {
        block.addEventListener('dragstart', handleDragStart);
        block.addEventListener('dragend', handleDragEnd);
    });
    
    // åˆå§‹åŒ–ç­”æ¡ˆå€å¡Šçš„æ‹–æ”¾åŠŸèƒ½
    answerSlots.forEach(slot => {
        slot.addEventListener('dragover', handleSlotDragOver);
        slot.addEventListener('drop', e => handleSlotDrop(e, questionId));
        slot.addEventListener('dragenter', handleSlotDragEnter);
        slot.addEventListener('dragleave', handleSlotDragLeave);
        
        // ç‚ºå·²ç¶“æ”¾ç½®çš„ç¨‹å¼ç¢¼å¡Šæ·»åŠ ç§»é™¤åŠŸèƒ½
        const existingBlock = slot.querySelector('.code-block');
        if (existingBlock) {
            addRemoveButton(existingBlock, slot, questionId);
        }
    });
    
    // æ‰“äº‚å·¦å´ç¨‹å¼ç¢¼å¡Šé †åº
    shuffleCodeBlocks(questionId);
}

// åˆå§‹åŒ–ä¸‹æ‹‰é¸å–®å¡«ç©ºé¡Œ
function initializeDropdownFillblank(questionElement) {
    const container = questionElement.querySelector('.dropdown-fillblank-container');
    if (!container) return;
    
    const questionId = container.dataset.questionId;
    const fillblankTextElement = container.querySelector('.fillblank-text');
    
    if (!fillblankTextElement) return;
    
    // ç²å–é¡Œç›®è³‡æ–™
    const questionData = window.questionsData.find(q => q.id == questionId);
    if (!questionData || !questionData.blanks) return;
    
    let fillblankText = questionData.fillblank_text;
    
    // æ‰¾åˆ°æ‰€æœ‰ {{ '{{}}' }} ä¸¦æ›¿æ›ç‚ºä¸‹æ‹‰é¸å–®
    let blankIndex = 0;
    fillblankText = fillblankText.replace(/\{\{[^}]*\}\}/g, function(match) {
        const blank = questionData.blanks[blankIndex];
        if (!blank) return match;
        
        let selectHTML = `<select id="blank_${blankIndex}_q${questionId}" onchange="saveDropdownFillblankAnswer(${questionId}, ${blankIndex}, this.value)" style="margin: 0 0.25rem; padding: 0.25rem; border: 1px solid #ddd; border-radius: 3px; font-size: 1rem; font-family: Consolas, monospace;">`;
        selectHTML += '<option value="">è«‹é¸æ“‡...</option>';
        
        blank.options.forEach(option => {
            // æ³¨æ„ï¼šHTMLçš„optionå…ƒç´ ä¸æ”¯æŒå¤šè¡Œæ˜¾ç¤ºï¼Œä½†æˆ‘ä»¬ä»ç„¶ä¿ç•™åŸå§‹æ ¼å¼ç”¨äºå€¼
            selectHTML += `<option value="${option}">${option.replace(/\n/g, ' ')}</option>`;
        });
        
        selectHTML += '</select>';
        blankIndex++;
        
        return selectHTML;
    });
    
    fillblankTextElement.innerHTML = fillblankText;
}

// å„²å­˜ä¸‹æ‹‰é¸å–®å¡«ç©ºé¡Œç­”æ¡ˆ
function saveDropdownFillblankAnswer(questionId, blankIndex, value) {
    if (!studentAnswers[questionId]) {
        studentAnswers[questionId] = {};
    }
    studentAnswers[questionId][`blank_${blankIndex}`] = value;
}

let draggedElement = null;

function handleDragStart(e) {
    draggedElement = e.target;
    e.target.classList.add('dragging');
}

function handleDragEnd(e) {
    e.target.classList.remove('dragging');
    draggedElement = null;
    
    // ç§»é™¤æ‰€æœ‰é«˜äº®æ•ˆæœ
    document.querySelectorAll('.answer-slot').forEach(slot => {
        slot.classList.remove('slot-highlight', 'drag-over');
    });
}

function handleSlotDragOver(e) {
    e.preventDefault();
}

function handleSlotDragEnter(e) {
    e.preventDefault();
    const targetSlot = e.currentTarget;
    
    // å›ºå®šå€å¡Šä¸é¡¯ç¤ºæ‹–æ‹‰é«˜äº®æ•ˆæœ
    if (targetSlot.dataset.fixed === 'true') {
        return;
    }
    
    if (draggedElement && !targetSlot.querySelector('.code-block')) {
        targetSlot.classList.add('slot-highlight');
    }
}

function handleSlotDragLeave(e) {
    // åªæœ‰ç•¶é›¢é–‹çš„æ˜¯ç­”æ¡ˆå€å¡Šæœ¬èº«æ™‚æ‰ç§»é™¤é«˜äº®
    if (!e.currentTarget.contains(e.relatedTarget)) {
        e.currentTarget.classList.remove('slot-highlight');
    }
}

function handleSlotDrop(e, questionId) {
    e.preventDefault();
    e.stopPropagation();
    
    if (!draggedElement) return;
    
    const targetSlot = e.currentTarget;
    
    // ç¦æ­¢åœ¨å›ºå®šå€å¡Šä¸Šæ‹–æ”¾
    if (targetSlot.dataset.fixed === 'true') {
        targetSlot.classList.remove('slot-highlight');
        alert('æ­¤ä½ç½®æ˜¯å›ºå®šçš„ç¨‹å¼ç¢¼å€å¡Šï¼Œç„¡æ³•æ”¾ç½®å…¶ä»–ç¨‹å¼ç¢¼');
        return;
    }
    
    // æª¢æŸ¥é€™å€‹å€å¡Šæ˜¯å¦å·²ç¶“æœ‰ç¨‹å¼ç¢¼å¡Š
    if (targetSlot.querySelector('.code-block')) {
        targetSlot.classList.remove('slot-highlight');
        return;
    }
    
    // è¤‡è£½ç¨‹å¼ç¢¼å¡Šåˆ°ç›®æ¨™å€åŸŸ
    const clonedBlock = draggedElement.cloneNode(true);
    clonedBlock.classList.remove('dragging');
    clonedBlock.draggable = false;
    
    // ç¢ºä¿ä»£ç¢¼å¡Šæ¨£å¼æ­£ç¢ºï¼ˆä¸é¡¯ç¤ºæ¨™ç±¤ï¼‰
    clonedBlock.style.wordBreak = 'keep-all';
    clonedBlock.style.display = 'block';
    clonedBlock.style.width = '100%';
    clonedBlock.style.overflow = 'auto';
    clonedBlock.style.padding = '0.4rem 1rem';
    clonedBlock.style.height = 'auto';
    clonedBlock.style.minHeight = '0';
    clonedBlock.style.lineHeight = '1.4';
    
    // éš±è—åŸå§‹çš„æç¤ºæ–‡å­—
    const slotContent = targetSlot.querySelector('.slot-content');
    slotContent.style.display = 'none';
    
    // æ·»åŠ ç¨‹å¼ç¢¼å¡Šåˆ°å€å¡Šä¸­
    targetSlot.appendChild(clonedBlock);
    targetSlot.classList.add('slot-occupied');
    targetSlot.classList.remove('slot-highlight');
    
    // æ·»åŠ ç§»é™¤æŒ‰éˆ•
    addRemoveButton(clonedBlock, targetSlot, questionId);
    
    updateParsonsAnswer(questionId);
}

function addRemoveButton(codeBlock, slot, questionId) {
    const removeBtn = document.createElement('button');
    removeBtn.textContent = 'âœ•';
    removeBtn.style.cssText = 'position: absolute; top: 8px; right: 8px; background: #e74c3c; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px; z-index: 10; display: flex; align-items: center; justify-content: center; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.2);';
    removeBtn.onmouseenter = () => {
        removeBtn.style.background = '#c0392b';
        removeBtn.style.transform = 'scale(1.1)';
    };
    removeBtn.onmouseleave = () => {
        removeBtn.style.background = '#e74c3c';
        removeBtn.style.transform = 'scale(1)';
    };
    removeBtn.onclick = (e) => {
        e.stopPropagation();
        codeBlock.remove();
        slot.classList.remove('slot-occupied');
        
        // é‡æ–°é¡¯ç¤ºæç¤ºæ–‡å­—
        const slotContent = slot.querySelector('.slot-content');
        slotContent.style.display = 'flex';
        
        updateParsonsAnswer(questionId);
    };
    
    codeBlock.style.position = 'relative';
    codeBlock.style.paddingRight = '35px'; // ç‚ºåˆªé™¤æŒ‰éˆ•é ç•™ç©ºé–“
    codeBlock.appendChild(removeBtn);
}

function shuffleCodeBlocks(questionId) {
    const bank = document.querySelector(`#code-bank-${questionId}`);
    const blocks = Array.from(bank.children);
    
    // Fisher-Yates æ´—ç‰Œæ¼”ç®—æ³•
    for (let i = blocks.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        bank.appendChild(blocks[j]);
        [blocks[i], blocks[j]] = [blocks[j], blocks[i]];
    }
}

function updateParsonsAnswer(questionId) {
    const targetZone = document.querySelector(`#code-target-${questionId}`);
    const answerSlots = targetZone.querySelectorAll('.answer-slot');
    
    // æ”¶é›†æ¯å€‹ç©ºæ ¼çš„æ¨™ç±¤(A, B, C...)
    const slotAnswers = {};
    
    answerSlots.forEach(slot => {
        const slotNumber = slot.dataset.slot;
        
        // è·³éå›ºå®šå€å¡Š
        if (slot.dataset.fixed === 'true') {
            return;
        }
        
        const block = slot.querySelector('.code-block');
        if (block) {
            const blockLabel = block.dataset.label;
            slotAnswers[slotNumber] = blockLabel;
        }
    });
    
    // å„²å­˜ç­”æ¡ˆ
    studentAnswers[questionId] = {
        slot_answers: slotAnswers
    };
    
    // åœ¨æ§åˆ¶å°è¼¸å‡ºç­”æ¡ˆï¼Œæ–¹ä¾¿èª¿è©¦
    console.log(`Question ${questionId} answer updated:`, studentAnswers[questionId]);
}

// æ”¶é›†å¡«ç©ºé¡Œå’Œä¸‹æ‹‰é¸å–®ç­”æ¡ˆ
function collectTextAnswers() {
    const fillBlanks = document.querySelectorAll('input[id^="answer-"]');
    fillBlanks.forEach(input => {
        const questionId = input.id.replace('answer-', '');
        studentAnswers[questionId] = input.value;
    });
    
    const dropdowns = document.querySelectorAll('select[id^="answer-"]');
    dropdowns.forEach(select => {
        const questionId = select.id.replace('answer-', '');
        studentAnswers[questionId] = select.value;
    });
}

async function submitQuiz() {
    if (!confirm('ç¢ºå®šè¦æäº¤æ¸¬é©—å—ï¼Ÿæäº¤å¾Œå°‡ç„¡æ³•ä¿®æ”¹ã€‚')) {
        return;
    }
    
    // æ”¶é›†æ‰€æœ‰ç­”æ¡ˆ
    collectTextAnswers();
    
    const studentName = document.getElementById('student-name').value;
    const studentEmail = document.getElementById('student-email').value;
    
    // èª¿è©¦ï¼šæª¢æŸ¥ç­”æ¡ˆæ”¶é›†æƒ…æ³
    console.log('=== æäº¤å‰ç­”æ¡ˆæª¢æŸ¥ ===');
    console.log('studentAnswers object:', studentAnswers);
    console.log('Object keys:', Object.keys(studentAnswers));
    console.log('Object values:', Object.values(studentAnswers));
    console.log('JSON representation:', JSON.stringify(studentAnswers));
    
    // æª¢æŸ¥æ˜¯å¦æœ‰ç©ºç­”æ¡ˆ
    if (Object.keys(studentAnswers).length === 0) {
        console.error('ERROR: studentAnswers is empty!');
        console.log('Attempting to collect answers from DOM...');
        
        // å˜—è©¦å¾DOMæ”¶é›†ç­”æ¡ˆ
        document.querySelectorAll('.option.selected').forEach(option => {
            const questionId = option.closest('.question-card').dataset.questionId;
            const value = option.getAttribute('data-option-value');
            console.log(`Found selected option: Q${questionId} = ${value}`);
            studentAnswers[questionId] = value;
        });
        
        console.log('After DOM collection:', studentAnswers);
    }
    
    try {
        const response = await fetch('/api/quiz/{{ quiz_bank.access_code }}/submit', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                student_name: studentName,
                student_email: studentEmail,
                answers: studentAnswers
            })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            // éš±è—æ¸¬é©—å…§å®¹
            document.getElementById('quiz-questions').style.display = 'none';
            document.getElementById('quiz-progress').style.display = 'none';
            
            // é¡¯ç¤ºçµæœ
            document.getElementById('completion-message').style.display = 'block';
            document.getElementById('score-percentage').textContent = result.percentage + '%';
            document.getElementById('score-details').textContent = `å¾—åˆ†ï¼š${result.score} / ${result.total_points} åˆ†`;
            
            // æ·»åŠ æŸ¥çœ‹è©³æƒ…æŒ‰éˆ•
            const detailsButton = document.createElement('a');
            detailsButton.href = `/result/${result.submission_id}`;
            detailsButton.className = 'btn';
            detailsButton.style.marginTop = '1rem';
            detailsButton.textContent = 'æŸ¥çœ‹æ¸¬é©—è©³æƒ…';
            document.getElementById('score-display').appendChild(detailsButton);
            
            // æ»¾å‹•åˆ°é ‚éƒ¨
            window.scrollTo(0, 0);
        } else {
            alert(result.error || 'æäº¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
        }
    } catch (error) {
        alert('ç¶²è·¯éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥é€£ç·š');
    }
}

// é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // é˜²æ­¢æ„å¤–é›¢é–‹é é¢
    window.addEventListener('beforeunload', function(e) {
        if (quizStarted && document.getElementById('completion-message').style.display === 'none') {
            e.preventDefault();
            e.returnValue = 'æ‚¨é‚„æœªæäº¤æ¸¬é©—ï¼Œç¢ºå®šè¦é›¢é–‹å—ï¼Ÿ';
        }
    });
    
    // åˆå§‹æ¸²æŸ“ MathJax
    if (typeof MathJax !== 'undefined') {
        MathJax.typesetPromise().catch((err) => console.log('MathJax typeset error:', err));
    }
});
</script>

{% endblock %}
